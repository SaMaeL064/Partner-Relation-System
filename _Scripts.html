<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>

<script>
  // ==========================================
  // üåü BULLETPROOF INITIALIZATION üåü
  // ==========================================
  function initGlobalApp() {
      // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π Active ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á (‡∏Ñ‡∏£‡∏≠‡∏ö Try-Catch ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á)
      try {
          if (typeof google !== 'undefined' && google.script && google.script.url) {
              google.script.url.getLocation(function(location) {
                  const currentPage = location.parameter.page || 'home';
                  document.querySelectorAll('.nav-link-custom').forEach(el => el.classList.remove('active'));
                  const targetLink = document.querySelector(`.nav-link-custom[data-page="${currentPage}"]`);
                  if (targetLink) targetLink.classList.add('active');
                  else {
                      const homeLink = document.querySelector(`.nav-link-custom[data-page="home"]`);
                      if(homeLink) homeLink.classList.add('active');
                  }
              });
          }
      } catch (e) {
          console.warn("Sidebar active sync skipped:", e);
      }

      // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Config ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ User/Admin
      if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
              .withSuccessHandler(res => {
                  if(res && res.isAdmin) {
                      const configMenu = document.getElementById('nav-config');
                      if(configMenu) configMenu.classList.remove('d-none');
                  }
                  const userEmailEl = document.getElementById('userEmailDisplay');
                  if(userEmailEl) {
                      userEmailEl.textContent = (res && res.userEmail) ? res.userEmail : "Officer";
                  }
              })
              .withFailureHandler(err => {
                  console.error("Config Load Error:", err);
                  const userEmailEl = document.getElementById('userEmailDisplay');
                  if(userEmailEl) userEmailEl.textContent = "Offline/Error";
              })
              .getClientConfig();
      }

      // 3. ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Global Search (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
      const searchInput = document.getElementById('globalSearchInput');
      const resultsContainer = document.getElementById('globalSearchResults');
      let globalSearchTimeout = null;

      if (searchInput && resultsContainer) {
          searchInput.addEventListener('keyup', function(e) {
              clearTimeout(globalSearchTimeout);
              const keyword = e.target.value.trim();
              const spinner = document.getElementById('globalSearchSpinner');
              
              if (keyword.length < 3) {
                  resultsContainer.style.display = 'none';
                  if(spinner) spinner.classList.add('d-none');
                  return;
              }
              
              if(spinner) spinner.classList.remove('d-none');
              
              // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå 600ms ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏¥‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              globalSearchTimeout = setTimeout(() => {
                  if (typeof google !== 'undefined' && google.script && google.script.run) {
                      google.script.run
                          .withSuccessHandler(res => {
                              if(spinner) spinner.classList.add('d-none');
                              renderGlobalSearchResults(res);
                          })
                          .withFailureHandler(err => {
                              if(spinner) spinner.classList.add('d-none');
                              console.error("Search Error:", err);
                              resultsContainer.innerHTML = `<div class="p-3 text-center text-danger small">Error: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`;
                              resultsContainer.style.display = 'block';
                          })
                          .globalSmartSearch(keyword);
                  }
              }, 600); 
          });
          
          // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
          document.addEventListener('click', function(e) {
              if (!e.target.closest('#globalSearchInput') && !e.target.closest('#globalSearchResults')) {
                  resultsContainer.style.display = 'none';
              }
          });
      }
  }

  // ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à)
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGlobalApp);
  } else {
      initGlobalApp();
  }

  // ==========================================
  // üåü RENDER SEARCH RESULTS üåü
  // ==========================================
  function renderGlobalSearchResults(res) {
      const container = document.getElementById('globalSearchResults');
      container.innerHTML = '';
      
      if (!res.success) {
          container.innerHTML = `<div class="p-3 text-center text-danger small"><i class="fas fa-exclamation-triangle me-1"></i> ${res.message}</div>`;
          container.style.display = 'block';
          return;
      }
      
      if (!res.data || res.data.length === 0) {
          container.innerHTML = `
              <div class="text-center py-4">
                  <i class="fas fa-search fa-2x text-muted opacity-25 mb-2"></i>
                  <div class="small text-muted fw-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
              </div>`;
          container.style.display = 'block';
          return;
      }
      
      let html = `<h6 class="dropdown-header fw-bold text-primary mb-2 px-2 border-bottom pb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏à‡∏≠ ${res.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h6>`;
      
      res.data.forEach(item => {
          let badgesHtml = '';
          item.foundIn.forEach(mod => {
              let badgeClass = 'bg-secondary';
              if(mod.includes('Master')) badgeClass = 'bg-primary';
              else if(mod.includes('Onboard')) badgeClass = 'bg-info text-dark';
              else if(mod.includes('Annual')) badgeClass = 'bg-warning text-dark';
              
              badgesHtml += `<span class="badge ${badgeClass} me-1 mb-1 shadow-sm" style="font-size: 0.7rem; font-weight: 500;">${mod}</span>`;
          });
          
          html += `
              <a href="https://admin-test.beneat.co/professional/${item.code || ''}/profile" target="_blank" class="dropdown-item p-3 mb-2 rounded-3 border bg-light text-wrap transition-all hover-shadow" style="transition: all 0.2s;">
                  <div class="d-flex justify-content-between align-items-start mb-1">
                      <span class="fw-bold text-dark">${item.name}</span>
                      <span class="badge bg-white text-primary border">${item.code || '-'}</span>
                  </div>
                  <div class="small text-muted mb-2"><i class="far fa-id-card me-1 text-secondary"></i> ${item.idCard || '-'}</div>
                  <div class="d-flex flex-wrap">${badgesHtml}</div>
              </a>
          `;
      });
      
      container.innerHTML = html;
      container.style.display = 'block';
  }

  // ==========================================
  // üåü GLOBAL HELPERS üåü
  // ==========================================
  function showLoading() {
      Swal.fire({
          title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
          html: '<div class="spinner-border text-primary mt-2"></div>',
          showConfirmButton: false,
          allowOutsideClick: false,
          background: 'rgba(255, 255, 255, 0.95)',
          backdrop: 'rgba(0,0,0,0.3)'
      });
  }
  
  function hideLoading() {
      Swal.close();
  }
  
  function showError(msg) {
      Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: msg, confirmButtonColor: '#31C1D7' });
  }
</script>
