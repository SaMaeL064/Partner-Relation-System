<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Partner Relation (PRS)</title>
  
  <!-- SheetJS for Import Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Sarabun) -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- CSV Parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

  <?!= include('_Styles'); ?>

  <style>
    /* Card Hover Effect specific to stats */
    .status-card { 
        transition: all 0.2s ease; 
        cursor: pointer; 
        background: #fff;
        border-radius: 12px;
        border: 0;
        box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    .status-card:hover { 
        transform: translateY(-3px); 
        box-shadow: 0 10px 20px rgba(0,0,0,0.08); 
    }
    .status-card h3 { font-size: 1.8rem; margin-bottom: 0; font-weight: 700; }
    
    /* Active State for Cards */
    .status-card.active {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background-color: #f8fcfd;
        transform: translateY(-2px);
    }
    
    /* Active Borders */
    .status-card.active.border-primary { border: 2px solid #0d6efd !important; }
    .status-card.active.border-success { border: 2px solid #198754 !important; }
    .status-card.active.border-warning { border: 2px solid #ffc107 !important; }
    .status-card.active.border-danger { border: 2px solid #dc3545 !important; }
    .status-card.active.border-info { border: 2px solid #0dcaf0 !important; }

    .badge-soft-success { background-color: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
    .badge-soft-warning { background-color: #fff8e1; color: #e65100; border: 1px solid #ffecb3; }
    .badge-soft-danger { background-color: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }
    .badge-soft-info { background-color: #e1f5fe; color: #01579b; border: 1px solid #b3e5fc; }
    
    .badge-new {
        font-size: 0.65rem;
        background-color: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
        vertical-align: middle;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    /* Styling for highlighted recently updated rows */
    .row-updated {
        background-color: #d1e7dd !important; /* Success light */
        transition: background-color 2s ease;
    }
    #bulkUploadFile { display: none; }
  </style>
</head>
<body>

  <?!= include('_Sidebar'); ?>

  <div class="main-content">
    <?!= include('_Navbar'); ?>
    
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-end align-items-center mb-4">
            <div class="d-flex gap-2">
                <!-- Bulk Update Buttons -->
                <button class="btn btn-outline-secondary rounded-pill px-3 shadow-sm fw-bold" onclick="viewHistory()">
                    <i class="fas fa-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                </button>
                <button class="btn btn-success text-white rounded-pill px-3 shadow-sm fw-bold" onclick="document.getElementById('bulkUploadFile').click()" title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                    <i class="fas fa-file-upload me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (CSV/Excel)
                </button>
                <!-- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .xlsx, .xls, .csv -->
                <input type="file" id="bulkUploadFile" accept=".xlsx, .xls, .csv" onchange="handleBulkUpload(event)">
                
                <button class="btn btn-soft-primary rounded-pill px-3 shadow-sm" onclick="openExportModal()">
                    <i class="fas fa-file-export me-1"></i> Export CSV
                </button>
                <button class="btn btn-soft-success rounded-pill px-3 shadow-sm" onclick="exportMonthlyReport()">
                    <i class="fas fa-file-excel me-1"></i> Report
                </button>
            </div>
        </div>

        <!-- üåü Status Cards (Workflow Tabs) üåü -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 g-3 mb-4">
          <div class="col">
            <div class="card status-card border-0 shadow-sm border-start border-4 border-primary p-3 active" id="card-total" onclick="filterBySummary('')">
              <small class="text-muted fw-bold text-uppercase">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-primary" id="countTotal">0</h3>
                <i class="fas fa-users fs-4 text-primary opacity-25"></i>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card status-card border-0 shadow-sm border-start border-4 border-success p-3" id="card-verified" onclick="filterBySummary('Verified')">
              <small class="text-muted fw-bold text-uppercase">‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-success" id="countVerified">0</h3>
                <i class="fas fa-check-circle fs-4 text-success opacity-25"></i>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card status-card border-0 shadow-sm border-start border-4 border-warning p-3" id="card-pending" onclick="filterBySummary('Pending Result')">
              <small class="text-muted fw-bold text-uppercase">‡∏£‡∏≠‡∏ú‡∏• (‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-warning" id="countPending">0</h3>
                <i class="fas fa-exclamation-triangle fs-4 text-warning opacity-25"></i>
              </div>
            </div>
          </div>
           <div class="col">
            <div class="card status-card border-0 shadow-sm border-start border-4 border-danger p-3" id="card-notverified" onclick="filterBySummary('Not Verified')">
               <small class="text-muted fw-bold text-uppercase">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô/‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-danger" id="countNotVerified">0</h3>
                <i class="fas fa-times-circle text-danger opacity-25 fs-4"></i>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card status-card border-0 shadow-sm border-start border-4 border-info p-3" id="card-progress" onclick="filterBySummary('In Progress')">
              <small class="text-muted fw-bold text-uppercase">In Progress</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-info" id="countProgress">0</h3>
                <i class="fas fa-spinner fs-4 text-info opacity-25"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                     <label class="form-label small text-muted fw-bold">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                     <div class="input-group">
                         <select class="form-select bg-light border-end-0" id="filterMode" style="max-width: 90px;" onchange="toggleFilterMode()">
                             <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                             <option value="year">‡∏õ‡∏µ</option>
                         </select>
                         
                         <!-- Month Picker -->
                         <input type="text" class="form-control border-start-0" id="monthFilter" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." readonly>
                         
                         <!-- Year Picker -->
                         <select class="form-select border-start-0 d-none" id="yearFilter" onchange="loadData()"></select>

                         <!-- Clear Button -->
                         <button class="btn btn-light border border-start-0 text-muted" type="button" onclick="clearDateFilter()" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)">
                            <i class="fas fa-times"></i>
                         </button>
                     </div>
                  </div>
                  <div class="col-md-2">
                     <label class="form-label small text-muted fw-bold">‡∏®‡∏π‡∏ô‡∏¢‡πå</label>
                     <select class="form-select" id="centerFilter" onchange="filterTable()">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                     </select>
                  </div>
                  <div class="col-md-2">
                     <label class="form-label small text-muted fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                     <select class="form-select" id="statusFilter" onchange="filterTable()">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                     </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                      <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£..." onkeyup="filterTable()">
                    </div>
                  </div>
                  <div class="col-md-2 text-end">
                    <button class="btn btn-primary-theme w-100 rounded-pill shadow-sm" onclick="openAddModal()">
                      <i class="fas fa-plus me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                  </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
          <div class="table-responsive">
              <table class="table table-hover align-middle" id="dataTable">
                <thead class="table-light">
                  <tr>
                    <th class="text-center">#</th>
                    <th>‡∏£‡∏´‡∏±‡∏™</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.</th>
                    <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                    <th>‡∏®‡∏π‡∏ô‡∏¢‡πå</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•</th>
                    <th class="bg-warning bg-opacity-10 border-warning">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FT</th>
                    <th style="min-width: 150px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    <th class="text-center">Export</th>
                    <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
          </div>
          <div id="noDataMessage" class="text-center py-5 text-muted" style="display:none;">
            <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </div>
        </div>
    </div>
  </div>

  <!-- Modal: Form -->
  <div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-white border-bottom-0 pb-0">
          <h5 class="modal-title fw-bold text-primary" id="formModalTitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-3">
          <form id="dataForm">
            <input type="hidden" id="recordId">
            <div class="row g-3">
              <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</label><input type="text" class="form-control" id="code"></div>
              <div class="col-md-8"><label class="form-label small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label><input type="text" class="form-control fw-bold" id="name" required></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å) <span class="text-danger">*</span></label><input type="text" class="form-control" id="idCard" maxlength="17" required oninput="formatIdCard(this)" onblur="validateIdCard(this)"><div class="invalid-feedback">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="text" class="form-control" id="phone"></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°</label><input type="text" class="form-control datepicker-input" id="trainingDate" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." readonly></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ <span class="text-danger">*</span></label><input type="text" class="form-control datepicker-input" id="submitDate" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." required readonly></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏®‡∏π‡∏ô‡∏¢‡πå (Center)</label><select class="form-select" id="center"><option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå...</option></select></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (Officer)</label><input type="text" class="form-control bg-light" id="officer" readonly></div>
              
              <div id="officerSection" class="mt-3 pt-3 border-top bg-light p-3 rounded-3">
                  <h6 class="text-danger fw-bold mb-3 small"><i class="fas fa-user-shield me-2"></i>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h6>
                  <div class="row g-3">
                      <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•</label><input type="text" class="form-control datepicker-input" id="resultDate" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." readonly></div>
                      <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
                        <!-- üåü ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Auto Update ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ üåü -->
                        <input type="text" class="form-control" id="result" onchange="autoUpdateFtStatus()" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥, ‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">
                      </div>
                      <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FT</label><select class="form-select" id="ftStatus"><option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</option></select></div>
                      <div class="col-12"><label class="form-label small fw-bold text-muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea class="form-control" id="note" rows="2"></textarea></div>
                  </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0 bg-white">
          <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
          <button type="button" class="btn btn-primary-theme rounded-pill px-4 fw-bold shadow-sm" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üåü Upload Result Modal (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) üåü -->
  <div class="modal fade" id="uploadResultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-dark text-white border-bottom-0">
          <h5 class="modal-title fw-bold"><i class="fas fa-clipboard-check me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
            <div class="d-flex bg-light p-3 border-bottom justify-content-around">
                <div class="text-center"><h3 class="text-success fw-bold mb-0" id="resSuccessCount">0</h3><small class="text-muted fw-bold">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</small></div>
                <div class="text-center"><h3 class="text-danger fw-bold mb-0" id="resFailedCount">0</h3><small class="text-muted fw-bold">‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / ‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö</small></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</th>
                            <th>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                            <th class="text-center pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody id="uploadResultTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer bg-light border-top-0">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center pb-5 pt-0">
          <div class="mb-3 text-primary"><i class="fas fa-file-csv fa-3x"></i></div>
          <h5 class="fw-bold">Export CSV</h5>
          <p class="text-muted small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà)</p>
          <p class="badge bg-light text-primary mb-4 fs-6" id="exportMonthDisplay"></p>
          <div class="d-grid gap-2 col-10 mx-auto">
            <button class="btn btn-outline-success p-2 text-start" onclick="previewExport('Verified')"><i class="fas fa-check-circle me-2"></i> Verified (‡∏ú‡πà‡∏≤‡∏ô)</button>
            <button class="btn btn-outline-warning text-dark p-2 text-start" onclick="previewExport('Pending Result')"><i class="fas fa-exclamation-triangle me-2"></i> Pending Result (‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°)</button>
            <button class="btn btn-outline-danger p-2 text-start" onclick="previewExport('Not Verified')"><i class="fas fa-times-circle me-2"></i> Not Verified (‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)</button>
            <button class="btn btn-outline-info text-dark p-2 text-start" onclick="previewExport('In Progress')"><i class="fas fa-spinner me-2"></i> In Progress (‡∏£‡∏≠‡∏ú‡∏•)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light"><h5 class="modal-title fw-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Export</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Code</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="previewTableBody"></tbody></table></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-primary-theme" id="confirmExportBtn" onclick="confirmExport()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Download</button></div>
      </div>
    </div>
  </div>

  <!-- History Modal (Table Format) -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light border-bottom-0">
          <h5 class="modal-title fw-bold text-secondary"><i class="fas fa-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="20%" class="ps-4">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
                            <th width="25%">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
                            <th width="20%">‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th width="10%" class="text-center">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
                            <th width="10%" class="text-center">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</th>
                            <th width="15%" class="text-center pe-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer bg-light border-top-0">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <?!= include('_Scripts'); ?>
  <script>
    let globalData = [], centersList = [], resultList = [], ftStatusList = [];
    let currentUser = "", isUserAdmin = false;
    let formModal, exportModal, previewModal, monthPickerInstance, currentExportStatus = "";
    
    let historyModal;
    let recentlyUpdatedIds = [];

    window.onload = function() {
      formModal = new bootstrap.Modal(document.getElementById('formModal'));
      exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
      previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
      historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
      
      document.getElementById('pageTitle').textContent = "‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà (New Verification)";
      document.getElementById('pageSubtitle').textContent = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Master Data)";

      const today = new Date();
      monthPickerInstance = flatpickr("#monthFilter", { 
          plugins: [ new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "F Y", theme: "light" }) ], 
          locale: "th", 
          defaultDate: today, 
          onChange: function() { loadData(); } 
      });
      
      flatpickr(".datepicker-input", { dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", locale: "th", allowInput: true });
      populateYearDropdown(); 
      loadData();
    };
    
    // üåü Logic ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Auto Update ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏≠‡∏á (MASTER) üåü
    function autoUpdateFtStatus() {
        const resultVal = String(document.getElementById('result').value).trim().toLowerCase();
        
        if (resultVal.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || resultVal.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô') || resultVal === '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥') {
            document.getElementById('result').value = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; 
            document.getElementById('ftStatus').value = 'Verified';
            
            const today = new Date();
            const d = String(today.getDate()).padStart(2, '0');
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const y = today.getFullYear();
            setFlatpickrValue('resultDate', `${y}-${m}-${d}`);
            
            Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton: false, timer: 3000 });
            
        } else if (resultVal.includes('kyc ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || resultVal.includes('kyc‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || resultVal.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || resultVal === '‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥') {
            document.getElementById('result').value = '‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
            document.getElementById('ftStatus').value = 'Not Verified';
            
            const today = new Date();
            const d = String(today.getDate()).padStart(2, '0');
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const y = today.getFullYear();
            setFlatpickrValue('resultDate', `${y}-${m}-${d}`);
            
            Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton: false, timer: 3000 });
        }
    }

    function clearDateFilter() {
        const mode = document.getElementById('filterMode').value;
        if(mode === 'month') {
            if(monthPickerInstance) monthPickerInstance.clear();
        } else {
            document.getElementById('yearFilter').value = "";
        }
        loadData();
    }

    function formatDateDisplay(dateStr) {
      if (!dateStr) return "-";
      if (typeof dateStr === 'string' && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
          const parts = dateStr.split(/[\/\-\s]/); 
          if(parts.length >= 3) {
             const d = parseInt(parts[0]);
             const m = parseInt(parts[1]) - 1; 
             let y = parseInt(parts[2]);
             if (y > 2400) y -= 543;
             const date = new Date(y, m, d);
             return date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });
          }
      }
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return dateStr;
      return date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });
    }

    function setFlatpickrValue(fpId, dateStr) {
        const el = document.getElementById(fpId);
        if(el && el._flatpickr) {
            if(!dateStr) {
                el._flatpickr.clear();
            } else {
                if (typeof dateStr === 'string' && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
                    const parts = dateStr.split(/[\/\-\s]/);
                    if (parts.length >= 3) {
                        let d = parts[0].padStart(2, '0');
                        let m = parts[1].padStart(2, '0');
                        let y = parseInt(parts[2]);
                        if (y > 2400) y -= 543;
                        dateStr = `${y}-${m}-${d}`;
                    }
                }
                el._flatpickr.setDate(dateStr);
            }
        }
    }

    function populateYearDropdown() {
       const yearSelect = document.getElementById('yearFilter');
       const currentYear = new Date().getFullYear();
       yearSelect.innerHTML = "<option value=''>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>"; 
       for(let y = currentYear + 2; y >= currentYear - 3; y--) {
           let thaiYear = y + 543;
           let option = new Option(thaiYear, y);
           yearSelect.add(option);
       }
    }

    function toggleFilterMode() {
        const mode = document.getElementById('filterMode').value;
        const flatpickrInput = document.getElementById('monthFilter');
        const yearSelect = document.getElementById('yearFilter');
        if(mode === 'month') { flatpickrInput.classList.remove('d-none'); yearSelect.classList.add('d-none'); } 
        else { flatpickrInput.classList.add('d-none'); yearSelect.classList.remove('d-none'); }
    }

    function loadData() {
      const mode = document.getElementById('filterMode').value;
      let filterVal = (mode === 'month') ? document.getElementById('monthFilter').value : document.getElementById('yearFilter').value;
      showLoading();
      google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onFailure).getInitialData(filterVal);
    }

    function onDataLoaded(response) {
      hideLoading();
      globalData = response.data || [];
      currentUser = response.currentUser;
      isUserAdmin = response.isAdmin;
      centersList = response.centers || [];
      resultList = response.results || [];
      ftStatusList = response.ftStatuses || [];
      
      if(isUserAdmin && document.getElementById('nav-config')) document.getElementById('nav-config').classList.remove('d-none');

      populateDropdowns(); updateStats(); filterTable(); 
    }

    function populateDropdowns() {
      const centerFilter = document.getElementById('centerFilter');
      const centerForm = document.getElementById('center');
      const statusFilter = document.getElementById('statusFilter');
      const ftStatusForm = document.getElementById('ftStatus');

      const currCenterFilter = centerFilter.value; const currStatusFilter = statusFilter.value;
      centerFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'; centerForm.innerHTML = '<option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå...</option>';
      statusFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'; statusFilter.innerHTML += '<option value="NEW">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</option>';
      ftStatusForm.innerHTML = '<option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</option>';

      centersList.forEach(c => { centerFilter.add(new Option(c, c)); centerForm.add(new Option(c, c)); });
      ftStatusList.forEach(s => { statusFilter.add(new Option(s, s)); ftStatusForm.add(new Option(s, s)); });
      
      if(currCenterFilter) centerFilter.value = currCenterFilter;
      if(currStatusFilter) statusFilter.value = currStatusFilter;
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody'); tbody.innerHTML = "";
      const noDataMsg = document.getElementById('noDataMessage');
      if (data.length === 0) { noDataMsg.style.display = 'block'; return; }
      noDataMsg.style.display = 'none';

      const today = new Date();
      
      data.forEach((item, index) => {
        let tr = document.createElement('tr');
        
        if (recentlyUpdatedIds.includes(String(item.id))) {
            tr.classList.add('row-updated');
        }

        let badgeStyle = '';
        if(item.ftStatus === 'Verified') badgeStyle = 'badge-soft-success';
        else if(item.ftStatus === 'Pending Result') badgeStyle = 'badge-soft-warning';
        else if(item.ftStatus === 'Not Verified') badgeStyle = 'badge-soft-danger';
        else if(item.ftStatus === 'In Progress') badgeStyle = 'badge-soft-info';
        else badgeStyle = 'bg-light text-dark border'; 
        
        // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡∏´‡∏≤‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∑‡∏≠‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
        let resultHtml = item.result || '-';
        let rv = String(item.result).toLowerCase();
        if (rv.includes('‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥') && !rv.includes('‡πÑ‡∏°‡πà‡∏û‡∏ö')) {
             resultHtml = `<span class="badge bg-danger">${item.result}</span>`;
        } else if (rv.includes('kyc ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) {
             resultHtml = `<span class="badge bg-danger">${item.result}</span>`;
        }

        let newBadge = '';
        if (item.submitDate) {
            const submitDate = new Date(item.submitDate);
            if (today.getDate() === submitDate.getDate() &&
                today.getMonth() === submitDate.getMonth() &&
                today.getFullYear() === submitDate.getFullYear()) {
                newBadge = '<span class="badge-new">NEW</span>';
            }
        }

        let exportIcon = item.exportStatus ? `<i class="fas fa-file-export text-success fs-5" title="${item.exportStatus}"></i>` : '<span class="text-muted">-</span>';
        let safeName = (item.name || "").replace(/'/g, "\\'");
        let deleteBtn = isUserAdmin ? `<button class="btn btn-sm btn-soft-danger ms-1" onclick="deleteItem('${item.id}', '${safeName}')"><i class="fas fa-trash-alt"></i></button>` : '';
        let codeDisplay = item.code ? `<a href="https://admin-test.beneat.co/professional/${item.code}/profile" target="_blank" class="fw-bold text-primary text-decoration-none">${item.code}</a>` : '-';

        tr.innerHTML = `
          <td class="text-center">${index + 1}</td><td>${codeDisplay}</td><td>${formatDateDisplay(item.submitDate)}</td><td>${formatDateDisplay(item.trainingDate)}</td>
          <td class="fw-bold text-dark">${item.name} ${newBadge}</td><td class="font-monospace">${item.idCard}</td><td>${item.phone}</td><td>${item.center}</td>
          <td>${formatDateDisplay(item.resultDate)}</td><td class="bg-warning bg-opacity-10">${resultHtml}</td>
          <td><span class="badge badge-status ${badgeStyle}">${item.ftStatus}</span></td>
          <td class="text-muted small text-truncate" style="max-width: 150px;">${item.note}</td>
          <td class="text-center">${exportIcon}</td>
          <td class="text-center"><div class="d-flex justify-content-center align-items-center"><button class="btn btn-sm btn-soft-primary" onclick="openEditModalById('${item.id}')"><i class="fas fa-edit"></i></button>${deleteBtn}</div></td>
        `;
        tbody.appendChild(tr);
      });

      if (recentlyUpdatedIds.length > 0) {
          setTimeout(() => {
              document.querySelectorAll('.row-updated').forEach(el => el.classList.remove('row-updated'));
              recentlyUpdatedIds = []; 
          }, 3000);
      }
    }

    function filterBySummary(status) {
        const dropdown = document.getElementById('statusFilter');
        dropdown.value = status;
        updateActiveCard(status);
        
        if (status === 'Pending Result' || status === 'Not Verified' || status === 'In Progress') {
            const mode = document.getElementById('filterMode').value;
            let needReload = false;
            
            if(mode === 'month' && document.getElementById('monthFilter').value !== "") {
                if(monthPickerInstance) monthPickerInstance.clear();
                needReload = true;
            } else if(mode === 'year' && document.getElementById('yearFilter').value !== "") {
                document.getElementById('yearFilter').value = "";
                needReload = true;
            }
            
            if(needReload) {
                Swal.fire({
                    title: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                    text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...',
                    icon: 'info',
                    timer: 1500,
                    showConfirmButton: false
                });
                loadData(); 
                return;
            }
        }
        
        filterTable();
    }
    
    function updateActiveCard(status) {
        document.querySelectorAll('.status-card').forEach(el => el.classList.remove('active'));
        if (status === '') document.getElementById('card-total').classList.add('active');
        else if (status === 'Verified') document.getElementById('card-verified').classList.add('active');
        else if (status === 'Pending Result') document.getElementById('card-pending').classList.add('active');
        else if (status === 'Not Verified') document.getElementById('card-notverified').classList.add('active');
        else if (status === 'In Progress') document.getElementById('card-progress').classList.add('active');
    }

    function updateStats() {
      const total = globalData.length;
      document.getElementById('countTotal').textContent = total;
      document.getElementById('countVerified').textContent = globalData.filter(x => x.ftStatus === 'Verified').length;
      document.getElementById('countPending').textContent = globalData.filter(x => x.ftStatus === 'Pending Result').length;
      document.getElementById('countNotVerified').textContent = globalData.filter(x => x.ftStatus === 'Not Verified').length;
      document.getElementById('countProgress').textContent = globalData.filter(x => x.ftStatus === 'In Progress').length;
    }

    function filterTable() {
      const txt = document.getElementById('searchInput').value.toLowerCase();
      const centerFilter = document.getElementById('centerFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      const filtered = globalData.filter(item => {
        const matchesText = (item.name && item.name.toLowerCase().includes(txt)) || (item.idCard && item.idCard.includes(txt)) || (item.code && item.code.toLowerCase().includes(txt));
        const matchesCenter = (centerFilter === "" || item.center === centerFilter);
        let matchesStatus = false;
        if (statusFilter === "") matchesStatus = true;
        else if (statusFilter === "NEW") matchesStatus = (item.ftStatus === "" || item.ftStatus == null);
        else matchesStatus = (item.ftStatus === statusFilter);
        return matchesText && matchesCenter && matchesStatus;
      });
      renderTable(filtered);
    }

    function openAddModal() {
      document.getElementById('dataForm').reset();
      document.getElementById('recordId').value = "";
      document.getElementById('formModalTitle').textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
      document.getElementById('officer').value = currentUser;
      
      const today = new Date();
      document.getElementById('submitDate')._flatpickr.setDate(today);
      document.getElementById('trainingDate')._flatpickr.clear();
      document.getElementById('resultDate')._flatpickr.clear();
      document.getElementById('idCard').classList.remove('is-invalid', 'is-valid');
      document.getElementById('officerSection').style.display = 'none';
      formModal.show();
    }
    
    function openEditModalById(id) {
        const item = globalData.find(x => String(x.id) === String(id));
        if(item) openEditModal(item);
    }

    function openEditModal(item) {
      document.getElementById('recordId').value = item.id;
      document.getElementById('code').value = item.code;
      document.getElementById('name').value = item.name;
      document.getElementById('idCard').value = item.idCard; formatIdCard(document.getElementById('idCard'));
      document.getElementById('phone').value = item.phone;
      setFlatpickrValue('trainingDate', item.trainingDate);
      setFlatpickrValue('submitDate', item.submitDate);
      setFlatpickrValue('resultDate', item.resultDate);
      document.getElementById('center').value = item.center;
      document.getElementById('officer').value = item.officer;
      document.getElementById('result').value = item.result || "";
      document.getElementById('ftStatus').value = item.ftStatus;
      document.getElementById('note').value = item.note;
      document.getElementById('formModalTitle').textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      document.getElementById('officerSection').style.display = 'block';
      formModal.show();
    }

    function saveData() {
      const idInput = document.getElementById('idCard');
      if(idInput.value && !validateIdCard(idInput)) { Swal.fire('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '', 'warning'); return; }
      const form = {
        id: document.getElementById('recordId').value,
        code: document.getElementById('code').value,
        name: document.getElementById('name').value,
        idCard: idInput.value.replace(/-/g, ''),
        phone: document.getElementById('phone').value,
        trainingDate: document.getElementById('trainingDate').value,
        submitDate: document.getElementById('submitDate').value,
        center: document.getElementById('center').value,
        officer: document.getElementById('officer').value,
        resultDate: document.getElementById('resultDate').value,
        result: document.getElementById('result').value,
        ftStatus: document.getElementById('ftStatus').value,
        note: document.getElementById('note').value
      };
      if(!form.name || !form.idCard || !form.submitDate) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', 'warning'); return; }
      showLoading();
      google.script.run.withSuccessHandler(res => {
        hideLoading();
        if(res.success) { formModal.hide(); Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false }); loadData(); } 
        else showError(res.message);
      }).saveData(form);
    }

    function deleteItem(id, name) {
        Swal.fire({ title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((r) => {
            if (r.isConfirmed) { showLoading(); google.script.run.withSuccessHandler(res => { hideLoading(); if (res.success) { Swal.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '', 'success'); loadData(); } else showError(res.message); }).deleteData(id); }
        });
    }

    function formatIdCard(input) { let v = input.value.replace(/\D/g, '').substring(0, 13); if(v.length>12) input.value = `${v.substring(0,1)}-${v.substring(1,5)}-${v.substring(5,10)}-${v.substring(10,12)}-${v.substring(12,13)}`; else input.value = v; if(v.length === 13) validateIdCard(input); else input.classList.remove('is-invalid', 'is-valid'); }
    function validateIdCard(input) { const id = input.value.replace(/-/g, ''); if(id.length !== 13) { input.classList.add('is-invalid'); return false; } let sum = 0; for(let i=0; i<12; i++) sum += parseFloat(id.charAt(i)) * (13-i); const check = (11 - (sum % 11)) % 10; if(check === parseFloat(id.charAt(12))) { input.classList.remove('is-invalid'); input.classList.add('is-valid'); return true; } else { input.classList.add('is-invalid'); input.classList.remove('is-valid'); return false; } }
    function onFailure(e) { hideLoading(); showError(e.message); }
    
    function openExportModal() {
      const mode = document.getElementById('filterMode').value;
      let filterVal = (mode === 'month') ? document.getElementById('monthFilter').value : document.getElementById('yearFilter').value;
      let displayText = "";
      if(mode === 'month' && filterVal) { const d = new Date(filterVal + '-01'); displayText = "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: " + d.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' }); } 
      else if (mode === 'year' && filterVal) { displayText = "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ: " + (parseInt(filterVal) + 543); }
      else if (!filterVal) { displayText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"; } 
      document.getElementById('exportMonthDisplay').textContent = displayText;
      exportModal.show();
    }
    function previewExport(ftStatus) {
       currentExportStatus = ftStatus;
       const mode = document.getElementById('filterMode').value;
       const filterVal = (mode === 'month') ? document.getElementById('monthFilter').value : document.getElementById('yearFilter').value;
       showLoading();
       google.script.run.withSuccessHandler(showPreviewModal).withFailureHandler(onFailure).exportMasterCSV(ftStatus, filterVal, true);
    }
    function showPreviewModal(data) {
        hideLoading();
        if (!data || data.length === 0) { Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', 'info'); return; }
        const tbody = document.getElementById('previewTableBody'); tbody.innerHTML = "";
        data.forEach(row => { tbody.innerHTML += `<tr><td>${row.code}</td><td>${row.name}</td><td>${row.idCard}</td><td><span class="badge bg-secondary">${row.ftStatus}</span></td></tr>`; });
        exportModal.hide(); previewModal.show();
    }
    function confirmExport() {
       if (!currentExportStatus) return;
       const mode = document.getElementById('filterMode').value;
       const filterVal = (mode === 'month') ? document.getElementById('monthFilter').value : document.getElementById('yearFilter').value;
       previewModal.hide(); showLoading();
       google.script.run.withSuccessHandler(result => {
           hideLoading();
           if (result.count > 0) { downloadCSV(result.content, result.filename); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `Export ${result.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success'); loadData(); } 
           else Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
       }).withFailureHandler(onFailure).exportMasterCSV(currentExportStatus, filterVal, false);
    }
    function exportMonthlyReport() {
        const mode = document.getElementById('filterMode').value;
        let filterVal = (mode === 'month') ? document.getElementById('monthFilter').value : document.getElementById('yearFilter').value;
        showLoading();
        google.script.run.withSuccessHandler(res => {
            hideLoading();
            if (res.count > 0) { downloadCSV(res.content, res.filename); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success'); } 
            else Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info');
        }).withFailureHandler(onFailure).exportMonthlyReport(filterVal);
    }
    function downloadCSV(csvContent, filename) { const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); }

    // ==========================================
    // üåü Actionable Result Modal & Smart Update üåü
    // ==========================================
    function handleBulkUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
            Swal.fire('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .csv, .xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
            event.target.value = ''; 
            return;
        }

        const reader = new FileReader();
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                
                if (jsonData.length <= 1) {
                    Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'warning');
                    event.target.value = '';
                    return;
                }

                // Smart column detection
                const headers = jsonData[0].map(h => String(h||'').toLowerCase().trim());
                let idCol = 1; 
                let statusCol = 2; 
                
                headers.forEach((h, idx) => {
                    if (h.includes('id card') || h.includes('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£') || h.includes('‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô')) idCol = idx;
                    if (h.includes('target status') || h.includes('status') || h.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞') || h.includes('‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à') || h.includes('result')) statusCol = idx;
                });

                let records = [];
                for(let i=1; i<jsonData.length; i++) {
                    records.push({
                        idCard: jsonData[i][idCol] ? String(jsonData[i][idCol]).trim() : "",
                        status: jsonData[i][statusCol] ? String(jsonData[i][statusCol]).trim() : "" 
                    });
                }
                
                Swal.close();
                confirmBulkUpload(records, file.name);
            } catch (error) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', error.message, 'error');
            }
            event.target.value = ''; 
        };
        
        reader.onerror = function() {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
            event.target.value = '';
        }
        reader.readAsArrayBuffer(file);
    }

    function confirmBulkUpload(records, fileName) {
        Swal.fire({
            title: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`,
            text: `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#198754'
        }).then((result) => {
            if (result.isConfirmed) {
                processUploadToServer(records, fileName);
            }
        });
    }

    function processUploadToServer(records, fileName) {
        showLoading();
        google.script.run
            .withSuccessHandler(res => {
                hideLoading();
                if (res.success) {
                    recentlyUpdatedIds = res.updatedIds || []; 
                    
                    document.getElementById('resSuccessCount').textContent = res.successCount;
                    document.getElementById('resFailedCount').textContent = res.failedCount;
                    
                    const tbody = document.getElementById('uploadResultTableBody');
                    tbody.innerHTML = '';
                    
                    records.forEach(rec => {
                        if(!rec.idCard && !rec.status) return;
                        
                        const cleanId = String(rec.idCard).replace(/\D/g, '');
                        const matchedItem = globalData.find(x => String(x.idCard).replace(/\D/g, '') === cleanId);
                        const nameDisplay = matchedItem ? matchedItem.name : '<span class="text-muted small"><i class="fas fa-exclamation-circle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>';
                        const idDb = matchedItem ? matchedItem.id : null;
                        
                        let rowClass = '';
                        let statusBadge = `<span class="badge bg-secondary">${rec.status}</span>`;
                        let extraAction = '';
                        let rv = rec.status.toLowerCase();
                        
                        // üåü ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏ö‡πÉ‡∏ô Popup (MASTER Logic) üåü
                        if (rv.includes('kyc ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('kyc‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) {
                            rowClass = 'table-danger';
                            statusBadge = `<span class="badge bg-danger">${rec.status}</span>`;
                            extraAction = `<div class="text-danger mt-1" style="font-size: 0.7rem;"><i class="fas fa-magic"></i> ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô: ‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ / Not Verified</div>`;
                        } else if (rv.includes('verified') || rv.includes('‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rv.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) {
                            statusBadge = `<span class="badge bg-success">${rec.status}</span>`;
                            if (rv.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rv.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) {
                                extraAction = `<div class="text-success mt-1" style="font-size: 0.7rem;"><i class="fas fa-magic"></i> ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ / Verified</div>`;
                            }
                        } else if (rv.includes('pending') || rv.includes('‡∏£‡∏≠')) {
                            statusBadge = `<span class="badge bg-warning text-dark">${rec.status}</span>`;
                        }
                        
                        let resultStr = (res.updatedIds && idDb && res.updatedIds.includes(String(idDb))) 
                            ? '<span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß</span>'
                            : '<span class="text-danger fw-bold"><i class="fas fa-times-circle me-1"></i> ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>';
                            
                        let actionBtn = idDb 
                            ? `<button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="openEditModalById('${idDb}'); bootstrap.Modal.getInstance(document.getElementById('uploadResultModal')).hide();"><i class="fas fa-external-link-alt me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</button>` 
                            : '-';
                        
                        tbody.innerHTML += `
                            <tr class="${rowClass}">
                                <td class="ps-4 font-monospace">${rec.idCard}</td>
                                <td>${nameDisplay}</td>
                                <td>${statusBadge} ${extraAction}</td>
                                <td>${resultStr}</td>
                                <td class="text-center pe-4">${actionBtn}</td>
                            </tr>
                        `;
                    });
                    
                    new bootstrap.Modal(document.getElementById('uploadResultModal')).show();
                    loadData(); 
                } else {
                    showError(res.message);
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: " + err.message);
            })
            .processBulkUpdate(records, 'MASTER', fileName, currentUser); 
    }

    function viewHistory() {
        showLoading();
        google.script.run
            .withSuccessHandler(logs => {
                hideLoading();
                const tbody = document.getElementById('historyTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                if(!logs || logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</td></tr>';
                } else {
                    if(!window.uploadLogsData) window.uploadLogsData = [];
                    
                    logs.forEach((log, idx) => {
                        window.uploadLogsData[idx] = log;
                        
                        let failBadge = log.failedCount > 0 
                            ? `<span class="badge bg-danger rounded-pill px-2 py-1">${log.failedCount}</span>` 
                            : `<span class="text-muted small">-</span>`;
                            
                        let successBadge = log.successCount > 0
                            ? `<span class="badge bg-success rounded-pill px-2 py-1">${log.successCount}</span>`
                            : `<span class="text-muted small">-</span>`;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-4">
                                    <span class="fw-bold text-dark"><i class="far fa-clock me-2 text-muted"></i> ${log.timestamp}</span>
                                </td>
                                <td>
                                    <span class="small text-muted"><i class="fas fa-file-excel me-1 text-success"></i> ${log.fileName}</span>
                                </td>
                                <td>
                                    <span class="badge bg-light text-secondary border">${log.user}</span>
                                </td>
                                <td class="text-center">
                                    ${successBadge}
                                </td>
                                <td class="text-center">
                                    ${failBadge}
                                </td>
                                <td class="text-center pe-4">
                                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm" onclick="downloadFullLogCSV(${idx})" title="‡πÇ‡∏´‡∏•‡∏î CSV ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
                                        <i class="fas fa-download me-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                historyModal.show();
            })
            .withFailureHandler(err => { hideLoading(); showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ: " + err.message); })
            .getUploadLogs('MASTER'); 
    }

    function downloadFullLogCSV(idx) {
        const log = window.uploadLogsData[idx];
        if(!log) return;
        
        let csvContent = "ID Card,Target Status,Update Result,Reason\n";
        
        if(log.successItems && log.successItems.length > 0) {
            log.successItems.forEach(item => {
                csvContent += `="${item.idCard || ''}","${item.status || ''}","SUCCESS","Updated Successfully"\n`;
            });
        }
        
        if(log.failedItems && log.failedItems.length > 0) {
            log.failedItems.forEach(item => {
                csvContent += `="${item.idCard || ''}","${item.status || ''}","FAILED","${item.reason || ''}"\n`;
            });
        }

        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        const safeTime = String(log.timestamp).replace(/[:\/ ]/g, '_');
        link.setAttribute("download", `Master_Update_Details_${safeTime}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
  </script>
</body>
</html>
