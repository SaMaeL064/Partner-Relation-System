<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Fast Report - Executive Summary</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <?!= include('_Styles'); ?>

  <style>
    /* Dashboard Specific Styles */
    .kpi-card {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        border: 1px solid #f0f0f0;
        height: 100%;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.06); }
    
    .kpi-icon-box {
        width: 48px; height: 48px;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 15px;
    }
    .kpi-value { font-size: 2rem; font-weight: 700; color: #2d3436; line-height: 1.2; }
    .kpi-label { font-size: 0.9rem; color: #636e72; font-weight: 500; }
    
    .chart-container {
        background: #fff;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        border: 1px solid #f0f0f0;
        margin-bottom: 25px;
        min-height: 350px;
    }
    
    .chart-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #f8f9fa;
        padding-bottom: 10px;
    }
    
    .summary-table th { background-color: #f8f9fa; font-weight: 600; color: #495057; }
    .summary-table td { vertical-align: middle; }
    
    /* Colors */
    .bg-soft-primary { background-color: #e3f2fd; color: #0d6efd; }
    .bg-soft-success { background-color: #e8f5e9; color: #198754; }
    .bg-soft-warning { background-color: #fff3cd; color: #ffc107; }
    .bg-soft-danger { background-color: #f8d7da; color: #dc3545; }
    .bg-soft-info { background-color: #e1f5fe; color: #0dcaf0; }
    
    .text-trend-up { color: #198754; font-size: 0.8rem; }
    .text-trend-down { color: #dc3545; font-size: 0.8rem; }

    /* Custom Rating Box */
    .rating-clickable-box {
        cursor: pointer; 
        background: #fffdf5; 
        border: 1px solid #ffecb5; 
        transition: all 0.2s;
    }
    .rating-clickable-box:hover {
        transform: translateY(-3px); 
        box-shadow: 0 6px 15px rgba(255, 193, 7, 0.15);
        background: #fffbef;
    }
  </style>
</head>
<body>

  <?!= include('_Sidebar'); ?>

  <div class="main-content">
    <?!= include('_Navbar'); ?>
    
    <div class="container-fluid">
        <!-- Header & Filters -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h4 class="fw-bold text-dark mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>Fast Report</h4>
                <small class="text-muted">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Executive Summary)</small>
            </div>
            
            <div class="d-flex gap-2">
                <div class="input-group shadow-sm" style="width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="far fa-calendar-alt text-primary"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="dateFilter" placeholder="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Time)" readonly>
                    <button class="btn btn-light border-start-0 text-muted" type="button" onclick="clearDateFilter()" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <select class="form-select shadow-sm" id="centerFilter" style="width: 150px;" onchange="loadReportData()">
                    <option value="ALL">‡∏ó‡∏∏‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå</option>
                    <!-- JS Populated -->
                </select>
                
                <button class="btn btn-primary-theme shadow-sm rounded-circle" onclick="loadReportData()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Row 1: KPI Highlights -->
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (Onboard)</div>
                            <div class="kpi-value text-primary" id="kpi-onboard">0</div>
                        </div>
                        <div class="kpi-icon-box bg-soft-primary"><i class="fas fa-user-plus"></i></div>
                    </div>
                    <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-primary" id="prog-onboard" style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2 d-block" id="sub-onboard">‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏° 0 ‡∏Ñ‡∏ô</small>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card">
                     <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                            <div class="kpi-value text-success" id="kpi-firstjob">0</div>
                        </div>
                        <div class="kpi-icon-box bg-soft-success"><i class="fas fa-check-circle"></i></div>
                    </div>
                     <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-success" id="prog-firstjob" style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2 d-block" id="sub-firstjob">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 0.0 ‡∏î‡∏≤‡∏ß</small>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡πÉ‡∏´‡∏°‡πà)</div>
                            <div class="kpi-value text-info" id="kpi-verify">0</div>
                        </div>
                        <div class="kpi-icon-box bg-soft-info"><i class="fas fa-file-signature"></i></div>
                    </div>
                     <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-info" id="prog-verify" style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2 d-block" id="sub-verify">‡∏£‡∏≠‡∏ú‡∏•‡∏≠‡∏µ‡∏Å 0 ‡∏Ñ‡∏ô</small>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                            <div class="kpi-value text-warning" id="kpi-annual">0</div>
                        </div>
                        <div class="kpi-icon-box bg-soft-warning"><i class="fas fa-calendar-check"></i></div>
                    </div>
                     <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-warning" id="prog-annual" style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2 d-block" id="sub-annual">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 0 ‡∏Ñ‡∏ô</small>
                </div>
            </div>
        </div>
        
        <!-- Row 2: Trend Analysis -->
        <div class="row mb-4">
             <div class="col-12">
                 <div class="chart-container" style="min-height: auto;">
                     <div class="chart-header">
                        <h5 class="fw-bold mb-0 text-secondary"><i class="fas fa-chart-area me-2"></i>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily Trend)</h5>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="chartTrend"></canvas>
                    </div>
                 </div>
             </div>
        </div>

        <!-- Row 3: Detailed Charts & Tables -->
        <div class="row g-4">
            
            <!-- 1. Onboard Funnel -->
            <div class="col-lg-8">
                <div class="chart-container h-100">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0 text-secondary">1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö (Onboard Funnel)</h5>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-md-7">
                             <canvas id="chartOnboard"></canvas>
                        </div>
                        <div class="col-md-5">
                            <table class="table table-sm summary-table table-bordered">
                                <tbody>
                                    <tr>
                                        <td><span class="badge bg-primary rounded-pill">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</span></td>
                                        <td class="text-end fw-bold" id="tbl-ob-open">0</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-warning text-dark rounded-pill">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</span></td>
                                        <td class="text-end fw-bold" id="tbl-ob-wait">0</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-secondary rounded-pill">‡∏¢‡∏∏‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</span></td>
                                        <td class="text-end fw-bold" id="tbl-ob-stop">0</td>
                                    </tr>
                                    <tr class="table-light">
                                        <td class="fw-bold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                                        <td class="text-end fw-bold text-primary" id="tbl-ob-total">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. First Job Status -->
            <div class="col-lg-4">
                <div class="chart-container h-100">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0 text-secondary">2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å</h5>
                    </div>
                    <canvas id="chartFirstJob" style="max-height: 250px;"></canvas>
                    
                    <!-- üåü ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ -->
                    <div class="mt-4 text-center p-3 rounded rating-clickable-box" onclick="openRatingModal()" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏î‡∏≤‡∏ß">
                         <h6 class="text-muted small fw-bold mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <i class="fas fa-hand-pointer text-warning ms-1"></i></h6>
                         <div class="display-6 fw-bold text-warning mb-1" id="fj-rating-avg">0.0</div>
                         <div id="fj-rating-stars" class="text-warning mb-2"></div>
                         <div class="badge bg-white text-muted border px-3 py-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
                    </div>
                </div>
            </div>
            
            <!-- 3. Verification Comparison -->
            <div class="col-12">
                <div class="chart-container">
                    <div class="chart-header">
                        <h5 class="fw-bold mb-0 text-secondary">3. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Verification Status)</h5>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="text-center fw-bold text-info mb-3">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (New)</h6>
                            <canvas id="chartNewVerify" style="max-height: 250px;"></canvas>
                        </div>
                         <div class="col-md-6">
                            <h6 class="text-center fw-bold text-warning mb-3">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Annual)</h6>
                            <canvas id="chartAnnualVerify" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                             <div class="alert alert-light border d-flex justify-content-between align-items-center">
                                 <span><i class="fas fa-wallet me-2 text-success"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</span>
                                 <div>
                                     <span class="badge bg-success me-2">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß: <span id="ann-paid">0</span></span>
                                     <span class="badge bg-danger">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <span id="ann-unpaid">0</span></span>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="text-center text-muted small mt-4 mb-5">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="dataTimestamp">-</span>
        </div>
    </div>
  </div>

  <!-- üåü Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏î‡∏≤‡∏ß üåü -->
  <div class="modal fade" id="ratingDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content border-0 shadow-lg">
              <div class="modal-header bg-warning bg-opacity-25 border-warning border-opacity-50">
                  <h5 class="modal-title fw-bold text-dark"><i class="fas fa-star text-warning me-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body bg-light p-4">
                  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                      <h6 class="fw-bold mb-0 text-secondary"><i class="fas fa-list-ul me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h6>
                      
                      <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏î‡∏≤‡∏ß -->
                      <div class="d-flex align-items-center bg-white border rounded-pill px-3 py-1 shadow-sm">
                          <span class="small text-muted me-2 fw-bold"><i class="fas fa-filter"></i> ‡∏Å‡∏£‡∏≠‡∏á:</span>
                          <select class="form-select form-select-sm border-0 bg-transparent shadow-none text-dark fw-bold" id="starFilter" onchange="filterRatingList()" style="width: 180px; cursor: pointer;">
                              <option value="ALL">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (All)</option>
                              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 ‡∏î‡∏≤‡∏ß)</option>
                              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 ‡∏î‡∏≤‡∏ß)</option>
                              <option value="LOW">1-3 ‡∏î‡∏≤‡∏ß (‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°)</option>
                              <option value="NO_REVIEW">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</option>
                          </select>
                      </div>
                  </div>
                  
                  <div class="table-responsive bg-white rounded-3 shadow-sm border border-light">
                      <table class="table table-hover align-middle mb-0">
                          <thead class="table-light">
                              <tr>
                                  <th class="text-center" width="10%">‡∏£‡∏´‡∏±‡∏™</th>
                                  <th width="18%">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                  <th width="12%">Booking</th>
                                  <th width="12%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                  <th class="text-center" width="13%">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</th>
                                  <th width="25%">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                  <th class="text-center" width="10%">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                              </tr>
                          </thead>
                          <tbody id="ratingListBody">
                              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
                          </tbody>
                      </table>
                  </div>
              </div>
              <div class="modal-footer border-top-0 bg-white">
                  <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
              </div>
          </div>
      </div>
  </div>

  <?!= include('_Scripts'); ?>
  
  <script>
    let charts = {};
    let rangePicker;
    let globalJobList = []; // ‡πÄ‡∏Å‡πá‡∏ö Data ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal
    let ratingModal;
    
    window.onload = function() {
        // Init Date Picker
        rangePicker = flatpickr("#dateFilter", {
             mode: "range",
             dateFormat: "Y-m-d",
             altInput: true,
             altFormat: "j M Y",
             locale: "th",
             onChange: function(selectedDates) { 
                 if(selectedDates.length===2) loadReportData(); 
                 else if(selectedDates.length===0) loadReportData();
             }
        });

        // Init Modal
        ratingModal = new bootstrap.Modal(document.getElementById('ratingDetailsModal'));
        
        // Load Data
        loadReportData();
        
        // Active Menu
        const navLinks = document.querySelectorAll('.nav-link-custom');
        navLinks.forEach(link => link.classList.remove('active'));
        const activeLink = document.querySelector('.nav-link-custom[data-page="fast_report"]');
        if(activeLink) activeLink.classList.add('active');
    };
    
    function clearDateFilter() {
        if(rangePicker) rangePicker.clear();
        loadReportData();
    }

    function loadReportData() {
        const dateRange = document.getElementById('dateFilter').value;
        const center = document.getElementById('centerFilter').value;
        
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        google.script.run.withSuccessHandler(renderDashboard).withFailureHandler(err => {
             Swal.fire('Error', err.message, 'error');
        }).getFastReportData(dateRange, center);
    }
    
    function renderDashboard(data) {
        Swal.close();
        document.getElementById('dataTimestamp').textContent = new Date().toLocaleString('th-TH');
        
        const centerSel = document.getElementById('centerFilter');
        if (centerSel.options.length <= 1 && data.centers) {
            data.centers.forEach(c => centerSel.add(new Option(c, c)));
        }

        // Store Job List in Global Variable for Modal
        globalJobList = data.firstJob.jobList || [];

        // --- 1. KPI Cards ---
        animateValue("kpi-onboard", data.onboard.openSystem);
        animateValue("kpi-firstjob", data.firstJob.completed);
        animateValue("kpi-verify", data.newVerify.verified);
        animateValue("kpi-annual", data.annualVerify.verified); 

        updateProgress("prog-onboard", "sub-onboard", data.onboard.openSystem, data.onboard.total, "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°");
        updateProgress("prog-firstjob", "sub-firstjob", data.firstJob.completed, data.onboard.openSystem, "‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö"); 
        updateProgress("prog-verify", "sub-verify", data.newVerify.verified, data.newVerify.total, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
        updateProgress("prog-annual", "sub-annual", data.annualVerify.paid, data.annualVerify.total, "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß");

        document.getElementById('sub-firstjob').textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${data.firstJob.avgRating} ‡∏î‡∏≤‡∏ß`;
        document.getElementById('sub-verify').textContent = `‡∏£‡∏≠‡∏ú‡∏• ${data.newVerify.pending} ‡∏Ñ‡∏ô`;
        document.getElementById('sub-annual').textContent = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${data.annualVerify.unpaid} ‡∏Ñ‡∏ô`;

        // --- 2. Tables ---
        document.getElementById('tbl-ob-open').textContent = data.onboard.openSystem;
        document.getElementById('tbl-ob-wait').textContent = data.onboard.waiting;
        document.getElementById('tbl-ob-stop').textContent = data.onboard.stopped;
        document.getElementById('tbl-ob-total').textContent = data.onboard.total;

        document.getElementById('fj-rating-avg').textContent = data.firstJob.avgRating;
        document.getElementById('fj-rating-stars').innerHTML = getStarHtml(data.firstJob.avgRating);
        
        document.getElementById('ann-paid').textContent = data.annualVerify.paid;
        document.getElementById('ann-unpaid').textContent = data.annualVerify.unpaid;

        // --- 3. Charts ---
        renderTrendChart(data.trend); 
        renderOnboardChart(data.onboard);
        renderFirstJobChart(data.firstJob);
        renderVerifyCharts(data.newVerify, data.annualVerify);
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏≤‡∏ß üåü
    function openRatingModal() {
        document.getElementById('starFilter').value = 'ALL'; // Reset Filter
        filterRatingList();
        ratingModal.show();
    }

    function filterRatingList() {
        const filterVal = document.getElementById('starFilter').value;
        const tbody = document.getElementById('ratingListBody');
        tbody.innerHTML = '';

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const filteredData = globalJobList.filter(job => {
            if (filterVal === 'ALL') return true;
            if (filterVal === 'NO_REVIEW') return job.rating === 'NO_REVIEW' || !job.rating;
            
            const score = parseFloat(job.rating);
            if (isNaN(score)) return false;

            if (filterVal === '5') return score === 5;
            if (filterVal === '4') return score === 4;
            if (filterVal === 'LOW') return score <= 3; // ‡∏î‡∏∂‡∏á 1-3 ‡∏î‡∏≤‡∏ß
            
            return true;
        });

        if (filteredData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x opacity-25 mb-3"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;
            return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏≠‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
        filteredData.sort((a, b) => {
            let scoreA = isNaN(parseFloat(a.rating)) ? 99 : parseFloat(a.rating);
            let scoreB = isNaN(parseFloat(b.rating)) ? 99 : parseFloat(b.rating);
            return scoreA - scoreB;
        });

        // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        filteredData.forEach(job => {
            let starDisplay = '<span class="badge bg-light text-muted border">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</span>';
            let rowClass = "";
            
            if (job.rating && job.rating !== 'NO_REVIEW') {
                const score = parseFloat(job.rating);
                let colorClass = 'text-warning';
                
                // Highlight ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡πâ‡∏≠‡∏¢
                if (score <= 3) {
                    colorClass = 'text-danger fw-bold';
                    rowClass = 'table-danger bg-opacity-10'; // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß
                }
                
                starDisplay = `<span class="${colorClass}">${'‚òÖ'.repeat(score)}</span>`;
            }

            // ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á Link ‡πÑ‡∏õ Profile
            const profileLink = `<a href="https://admin-test.beneat.co/professional/${job.maidCode}/profile" target="_blank" class="text-decoration-none badge bg-primary-soft text-primary border">${job.maidCode}</a>`;
            
            // üåü ‡∏™‡∏£‡πâ‡∏≤‡∏á Link ‡πÑ‡∏õ Booking
            let bookingDisplay = '-';
            if (job.bookingCode) {
                if (job.jobId) {
                    bookingDisplay = `<a href="https://admin-test.beneat.co/order/${job.jobId}/edit" target="_blank" class="fw-bold text-primary text-decoration-none">${job.bookingCode}</a>`;
                } else {
                    bookingDisplay = `<span class="fw-bold text-dark">${job.bookingCode}</span>`;
                }
            }

            // ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á Link ‡πÑ‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            const problemLink = job.problemId 
                ? `<a href="https://admin-test.beneat.co/report-problems/${job.problemId}/edit" target="_blank" class="badge bg-danger text-white text-decoration-none">${job.problemId}</a>` 
                : `<span class="text-muted">-</span>`;

            tbody.innerHTML += `
                <tr class="${rowClass}">
                    <td class="text-center">${profileLink}</td>
                    <td class="fw-bold text-dark">${job.name}</td>
                    <td>${bookingDisplay}</td>
                    <td class="small text-muted">${job.cleanDate || '-'}</td>
                    <td class="text-center" style="font-size: 1.1rem;">${starDisplay}</td>
                    <td class="small text-secondary" style="max-width: 250px; white-space: normal;">${job.comment || '<span class="text-black-50 fst-italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</span>'}</td>
                    <td class="text-center">${problemLink}</td>
                </tr>
            `;
        });
    }

    // --- Chart Rendering Functions ---
    function renderTrendChart(data) {
        const ctx = document.getElementById('chartTrend').getContext('2d');
        if (charts.trend) charts.trend.destroy();
        
        charts.trend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà',
                        data: data.onboard,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: '‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        data: data.firstJob,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } }
            }
        });
    }

    function renderOnboardChart(data) {
        const ctx = document.getElementById('chartOnboard').getContext('2d');
        if (charts.onboard) charts.onboard.destroy();
        
        charts.onboard = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°', '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö', '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°', '‡∏¢‡∏∏‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°'],
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏ô)',
                    data: [data.total, data.openSystem, data.waiting, data.stopped],
                    backgroundColor: ['#6c757d', '#0d6efd', '#ffc107', '#dc3545'],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function renderFirstJobChart(data) {
        const ctx = document.getElementById('chartFirstJob').getContext('2d');
        if (charts.firstjob) charts.firstjob.destroy();

        charts.firstjob = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', '‡∏£‡∏≠‡πÇ‡∏ó‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', '‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡∏ö‡∏á‡∏≤‡∏ô'],
                datasets: [{
                    data: [data.waitingJob, data.waitingCall, data.callDone, data.completed],
                    backgroundColor: ['#ffc107', '#0dcaf0', '#6c757d', '#198754'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function renderVerifyCharts(newData, annualData) {
        const ctxNew = document.getElementById('chartNewVerify').getContext('2d');
        if (charts.newVerify) charts.newVerify.destroy();
        charts.newVerify = new Chart(ctxNew, {
            type: 'pie',
            data: {
                labels: ['‡∏ú‡πà‡∏≤‡∏ô (Verified)', '‡∏£‡∏≠‡∏ú‡∏•/‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°', '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'],
                datasets: [{
                    data: [newData.verified, newData.pending, newData.notVerified],
                    backgroundColor: ['#198754', '#ffc107', '#dc3545']
                }]
            },
            options: { plugins: { legend: { position: 'right' } } }
        });

        const ctxAnn = document.getElementById('chartAnnualVerify').getContext('2d');
        if (charts.annualVerify) charts.annualVerify.destroy();
        charts.annualVerify = new Chart(ctxAnn, {
            type: 'pie',
            data: {
                labels: ['‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå/‡∏£‡∏≠‡∏ú‡∏•'],
                datasets: [{
                    data: [annualData.verified, (annualData.total - annualData.verified)],
                    backgroundColor: ['#198754', '#0dcaf0']
                }]
            },
            options: { plugins: { legend: { position: 'right' } } }
        });
    }

    // --- Helpers ---
    function animateValue(id, value) {
        const el = document.getElementById(id);
        el.innerText = value.toLocaleString();
    }
    
    function updateProgress(id, subId, val, total, totalLabel) {
        const percent = total > 0 ? (val / total) * 100 : 0;
        document.getElementById(id).style.width = percent + "%";
    }

    function getStarHtml(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) html += '<i class="fas fa-star"></i>';
            else if (i - 0.5 <= rating) html += '<i class="fas fa-star-half-alt"></i>';
            else html += '<i class="far fa-star"></i>';
        }
        return html;
    }
  </script>
</body>
</html>
