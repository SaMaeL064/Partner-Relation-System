<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Annual Verification</title>
  
  <!-- SheetJS for Import Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/ all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- CSV Parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

  <?!= include('_Styles'); ?>
  <style>
    /* Custom Badges for Groups */
    .badge-group-A { background-color: #198754; color: white; } 
    .badge-group-fired { background-color: #dc3545; color: white; } 
    .badge-group-default { background-color: #6c757d; color: white; }
    .badge-import-new { background-color: #0d6efd; color: white; margin-left: 5px; font-size: 0.7rem; }
    .badge-import-update { background-color: #fd7e14; color: white; margin-left: 5px; font-size: 0.7rem; }
    .note-input { border: 1px solid #e9ecef; border-radius: 20px; padding: 4px 10px; font-size: 0.85rem; min-width: 200px; background-color: #f8f9fa; }
    .note-input:focus { border-color: var(--ci-primary); outline: none; background-color: #fff; }
    
    /* Status Cards (Interactive) */
    .status-card { 
        transition: all 0.2s ease; 
        cursor: pointer; 
        border: 0; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.02); 
        background: #fff; 
        border-radius: 12px; 
        position: relative;
    }
    .status-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .status-card h3 { font-size: 1.8rem; font-weight: 700; margin-bottom: 0; }
    .status-icon { opacity: 0.3; font-size: 1.5rem; }
    
    /* Card Active State */
    .status-card.active { 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        background-color: #f8fcfd;
        transform: translateY(-2px);
    }
    /* Active Borders */
    .status-card.active.border-start-primary { border: 2px solid var(--ci-primary) !important; }
    .status-card.active.border-start-success { border: 2px solid #198754 !important; }
    .status-card.active.border-start-info { border: 2px solid #0dcaf0 !important; }
    .status-card.active.border-start-warning { border: 2px solid #ffc107 !important; }
    .status-card.active.border-start-danger { border: 2px solid #dc3545 !important; }

    .border-start-primary { border-left: 4px solid var(--ci-primary) !important; }
    .border-start-success { border-left: 4px solid #198754 !important; }
    .border-start-info { border-left: 4px solid #0dcaf0 !important; }
    .border-start-warning { border-left: 4px solid #ffc107 !important; }
    .border-start-danger { border-left: 4px solid #dc3545 !important; }
    
    .text-primary-theme { color: var(--ci-primary) !important; }

    /* Styling for highlighted recently updated rows */
    .row-updated {
        background-color: #d1e7dd !important; /* Success light */
        transition: background-color 2s ease;
    }
    #bulkUploadStatusFile { display: none; }
  </style>
</head>
<body>

  <?!= include('_Sidebar'); ?>

  <div class="main-content">
    <?!= include('_Navbar'); ?>
    
    <div class="container-fluid">
        <!-- Header (Minimal: Buttons Only) -->
        <div class="d-flex justify-content-end align-items-center mb-4">
            <div class="d-flex gap-2">
                <!-- Bulk Update History Button -->
                <button class="btn btn-outline-secondary rounded-pill px-3 shadow-sm fw-bold" onclick="viewHistory()">
                    <i class="fas fa-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                </button>
                <button class="btn btn-soft-primary rounded-pill px-3 shadow-sm" onclick="openExportModal()">
                    <i class="fas fa-file-export me-1"></i> Export CSV
                </button>
                <button class="btn btn-soft-success rounded-pill px-3 shadow-sm" onclick="exportAnnualReport()">
                    <i class="fas fa-file-excel me-1"></i> Report
                </button>
            </div>
        </div>
        
        <!-- Last Import Status -->
        <div id="lastImportDisplay" class="text-secondary small fw-bold mb-3 text-end" style="font-size: 0.75rem;"></div>

        <!-- üåü Status Cards (Workflow Tabs) üåü -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 g-3 mb-4">
          <div class="col">
            <div class="card status-card shadow-sm border-start-primary p-3 active" id="card-total" onclick="filterBySummary('total')">
              <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-primary-theme" id="countTotal">0</h3>
                <i class="fas fa-users status-icon text-primary"></i>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card status-card shadow-sm border-start-success p-3" id="card-verified" onclick="filterBySummary('verified')">
              <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-success" id="countVerified">0</h3>
                <i class="fas fa-check-circle status-icon text-success"></i>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card status-card shadow-sm border-start-info p-3" id="card-link-sent" onclick="filterBySummary('link_sent')">
              <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-info" id="countLinkSent">0</h3>
                <i class="fas fa-paper-plane status-icon text-info"></i>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card status-card shadow-sm border-start-warning p-3" id="card-paid" onclick="filterBySummary('paid')">
              <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-warning" id="countPaid">0</h3>
                <i class="fas fa-money-bill-wave status-icon text-warning"></i>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card status-card shadow-sm border-start-danger p-3" id="card-unpaid" onclick="filterBySummary('unpaid')">
               <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</small>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <h3 class="text-danger" id="countUnpaid">0</h3>
                <i class="fas fa-exclamation-circle status-icon text-danger"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Controls Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="far fa-calendar-alt text-primary"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" id="monthFilter" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." readonly>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£..." onkeyup="filterTable()">
                    </div>
                  </div>
                  <div class="col-md-6 text-end">
                    <div class="d-flex gap-2 justify-content-end flex-wrap">
                        <input type="file" id="importFile" accept=".xlsx, .xls, .csv" style="display:none;" onchange="handleFileSelect(this)">
                        
                        <!-- Bulk Status Update File Input -->
                        <input type="file" id="bulkUploadStatusFile" accept=".xlsx, .xls, .csv" style="display:none;" onchange="handleBulkUpload(event)">
                        
                        <button class="btn btn-success text-white rounded-pill shadow-sm fw-bold" onclick="document.getElementById('bulkUploadStatusFile').click()" title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (CSV/Excel 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)">
                          <i class="fas fa-file-upload me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (Excel)
                        </button>
                        
                        <button class="btn btn-info text-white rounded-pill shadow-sm" onclick="document.getElementById('importFile').click()" title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                          <i class="fas fa-file-import me-1"></i> ‡πÅ‡∏ô‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                        </button>
                        <button class="btn btn-primary-theme rounded-pill shadow-sm" onclick="openAddModal()">
                          <i class="fas fa-plus me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>
                  </div>
                </div>
            </div>
        </div>

        <!-- Filter Pills -->
        <div class="d-flex gap-3 flex-wrap mb-4 align-items-stretch">
            <div class="card flex-grow-1 border-0 shadow-sm" style="min-width: 250px;">
                 <div class="card-body p-2 d-flex align-items-center justify-content-between">
                     <span class="small fw-bold text-muted ms-2 text-nowrap"><i class="fas fa-history me-1"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>
                     <div class="btn-group btn-group-sm ms-2" role="group">
                        <input type="radio" class="btn-check" name="importFilter" id="btnImportAll" autocomplete="off" checked onchange="filterTable()">
                        <label class="btn btn-outline-secondary border-0 rounded-pill me-1 px-3" for="btnImportAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        
                        <input type="radio" class="btn-check" name="importFilter" id="btnImportNew" autocomplete="off" onchange="filterTable()">
                        <label class="btn btn-outline-primary border-0 rounded-pill me-1 px-3" for="btnImportNew" id="lblImportNew">‡πÉ‡∏´‡∏°‡πà</label>
                        
                        <input type="radio" class="btn-check" name="importFilter" id="btnImportUpdated" autocomplete="off" onchange="filterTable()">
                        <label class="btn btn-outline-warning text-dark border-0 rounded-pill px-3" for="btnImportUpdated" id="lblImportUpdated">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</label>
                     </div>
                 </div>
            </div>

            <div class="card border-0 shadow-sm" style="min-width: 180px;">
                 <div class="card-body p-2 d-flex align-items-center gap-2">
                     <span class="small fw-bold text-muted ms-2 text-nowrap"><i class="fas fa-users me-1"></i> ‡∏Å‡∏•‡∏∏‡πà‡∏°</span>
                     <select class="form-select form-select-sm border-0 bg-transparent fw-bold text-primary" id="groupFilter" onchange="filterTable()">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="H">H</option>
                        <option value="‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß">‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß</option>
                     </select>
                 </div>
            </div>

            <div class="card border-0 shadow-sm" style="min-width: 200px;">
                 <div class="card-body p-2 d-flex align-items-center gap-2">
                     <span class="small fw-bold text-muted ms-2 text-nowrap"><i class="fas fa-money-bill-wave me-1"></i> ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</span>
                     <select class="form-select form-select-sm border-0 bg-transparent fw-bold text-success" id="deductionFilter" onchange="filterTable()">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö</option>
                        <option value="outstanding">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</option>
                     </select>
                 </div>
            </div>
        </div>

        <!-- üåü Table (Reduced Columns for Payment Info) üåü -->
        <div class="table-container">
          <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th class="text-center">#</th>
                    <th>‡∏£‡∏´‡∏±‡∏™</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th class="text-center">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
                    <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th>
                    <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                    <th>‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Ø</th>
                    <!-- üåü ‡∏£‡∏ß‡∏° 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô, ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏±‡∏Å) ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üåü -->
                    <th style="min-width: 150px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th>
                    <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏•</th>
                    <th class="text-center bg-warning bg-opacity-10 border-warning">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</th>
                    <th style="min-width: 250px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</th>
                    <th class="text-center">Export</th>
                    <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
          </div>
          <div id="noData" class="text-center py-5 text-muted" style="display:none;">
              <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </div>
        </div>
    </div>
  </div>

  <!-- Modal: Add/Edit Annual -->
  <div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-white border-bottom-0 pb-0">
          <h5 class="modal-title fw-bold text-primary" id="modalTitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-3">
          
          <div id="searchSection" class="mb-4 p-3 bg-light rounded border border-primary border-opacity-25">
             <label class="form-label fw-bold text-primary"><i class="fas fa-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
             <div class="input-group">
                <input class="form-control" list="providerOptions" id="searchProviderInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onchange="onProviderSelect()">
                <datalist id="providerOptions"></datalist>
                <button class="btn btn-outline-secondary" onclick="document.getElementById('searchProviderInput').value='';" type="button">Clear</button>
             </div>
             <small class="text-muted ms-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
          </div>

          <form id="dataForm">
            <input type="hidden" id="recordId">
            <div class="row g-3 mb-4">
               <div class="col-md-3"><label class="form-label small fw-bold text-muted">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</label><input type="text" class="form-control bg-light" id="refCode"></div>
               <div class="col-md-5"><label class="form-label small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô <span class="text-danger">*</span></label><input type="text" class="form-control fw-bold bg-light" id="name" required></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏Å‡∏•‡∏∏‡πà‡∏° (Group) <span class="text-danger">*</span></label>
                  <select class="form-select" id="group" required>
                      <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°...</option>
                      <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="H">H</option>
                      <option value="‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß">‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß</option>
                  </select>
               </div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" class="form-control" id="idCard" maxlength="13"></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input type="text" class="form-control datepicker" id="birthDate"></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" class="form-control" id="phone"></div>
            </div>

            <div class="p-3 bg-light rounded mb-4 border">
                <h6 class="text-secondary fw-bold mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h6>
                <div class="row g-3">
                   <div class="col-md-3"><label class="form-label small">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô?</label>
                      <select class="form-select" id="consentStatus">
                          <option value="">- ‡∏£‡∏∞‡∏ö‡∏∏ -</option><option value="‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</option><option value="‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°">‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</option><option value="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
                      </select>
                   </div>
                   <div class="col-md-3"><label class="form-label small">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à</label><input type="number" class="form-control" id="amount" placeholder="0.00"></div>
                   <div class="col-md-3"><label class="form-label small text-danger">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</label><input type="number" class="form-control border-danger" id="outstanding" placeholder="0.00"></div>
                   <div class="col-md-3"><label class="form-label small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</label>
                      <select class="form-select fw-bold" id="deductionStatus">
                          <option value="">- ‡∏£‡∏∞‡∏ö‡∏∏ -</option><option value="‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö</option><option value="‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</option>
                          <option value="‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à">‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option value="‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à">‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option value="‡∏£‡∏≠‡∏´‡∏±‡∏Å">‡∏£‡∏≠‡∏´‡∏±‡∏Å</option>
                      </select>
                   </div>
                </div>
            </div>

            <div class="row g-3">
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</label>
                  <select class="form-select" id="channel" onchange="updateStatusOptions()">
                      <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á...</option>
                      <option value="App Man">App Man</option><option value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏á">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏á</option>
                  </select>
               </div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à</label>
                  <select class="form-select" id="statusProcess"><option value="" selected disabled>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô...</option></select>
               </div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•</label><input type="text" class="form-control datepicker" id="resultDate"></div>
               <!-- üåü ‡πÄ‡∏û‡∏¥‡πà‡∏° onchange event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</label><input type="text" class="form-control bg-light" id="result" onchange="autoUpdateResultStatus()"></div>
               <div class="col-md-8"><label class="form-label small fw-bold text-muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea class="form-control" id="note" rows="1" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea></div>
               <div class="d-none"><input type="text" id="officerEmail"><input type="text" class="form-control datepicker" id="submitDate"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0 bg-white">
          <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
          <button type="button" class="btn btn-primary-theme rounded-pill px-4 fw-bold shadow-sm" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üåü Upload Result Modal (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) üåü -->
  <div class="modal fade" id="uploadResultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-dark text-white border-bottom-0">
          <h5 class="modal-title fw-bold"><i class="fas fa-clipboard-check me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
            <div class="d-flex bg-light p-3 border-bottom justify-content-around">
                <div class="text-center"><h3 class="text-success fw-bold mb-0" id="resSuccessCount">0</h3><small class="text-muted fw-bold">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</small></div>
                <div class="text-center"><h3 class="text-danger fw-bold mb-0" id="resFailedCount">0</h3><small class="text-muted fw-bold">‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / ‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö</small></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</th>
                            <th>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                            <th class="text-center pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody id="uploadResultTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer bg-light border-top-0">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center pb-5 pt-0">
          <div class="mb-3 text-primary"><i class="fas fa-file-csv fa-3x"></i></div>
          <h4>Export CSV</h4>
          <p class="text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"</p>
          <p class="small mb-4 text-primary fw-bold" id="exportYearDisplay"></p>
          <div class="d-grid gap-2 col-10 mx-auto">
            <button class="btn btn-success p-3 text-start shadow-sm border-0" onclick="previewExport('ALL')">
              <div class="d-flex justify-content-between align-items-center"><span><i class="fas fa-check-circle me-2"></i> Export ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span><i class="fas fa-download"></i></div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light"><h5 class="modal-title">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Export (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Code</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="previewTableBody"></tbody></table></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-primary-theme" id="confirmExportBtn" onclick="confirmExport()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Download CSV</button></div>
      </div>
    </div>
  </div>

  <!-- History Modal (Table Format) -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light border-bottom-0">
          <h5 class="modal-title fw-bold text-secondary"><i class="fas fa-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="20%" class="ps-4">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
                            <th width="25%">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
                            <th width="20%">‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th width="10%" class="text-center">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
                            <th width="10%" class="text-center">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</th>
                            <th width="15%" class="text-center pe-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer bg-light border-top-0">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <?!= include('_Scripts'); ?>
  <script>
    let globalData = [], providerList = [], resultList = [], ftStatusList = [];
    let currentUser = "", isUserAdmin = false;
    let formModal, exportModal, previewModal, monthPickerInstance;
    let currentExportType = "", lastImportAdded = [], lastImportUpdated = [];
    let currentSummaryFilter = 'total'; 
    let recentlyUpdatedIds = [];
    let historyModal;

    window.onload = function() {
        formModal = new bootstrap.Modal(document.getElementById('formModal'));
        exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
        previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
        
        if(document.getElementById('pageTitle')) document.getElementById('pageTitle').textContent = "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ";
        if(document.getElementById('pageSubtitle')) document.getElementById('pageSubtitle').textContent = "Annual Verification";

        flatpickr(".datepicker", { dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", locale: "th" });
        const today = new Date();
        monthPickerInstance = flatpickr("#monthFilter", {
          plugins: [ new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "F Y", theme: "light" }) ],
          locale: "th", defaultDate: today,
          onChange: function() { loadData(); }
        });
        
        loadData(); loadProviderOptions(); loadLastImportInfo();
        
        google.script.run.withSuccessHandler(res => { 
            isUserAdmin = res.isAdmin;
            if(isUserAdmin && document.getElementById('nav-config')) {
                document.getElementById('nav-config').classList.remove('d-none');
            }
        }).getClientConfig();
    };

    function loadLastImportInfo() { google.script.run.withSuccessHandler(msg => { if(msg) document.getElementById('lastImportDisplay').innerHTML = `<i class="fas fa-history me-1"></i>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${msg}`; }).getLastImportLog(); }
    function excelDateToJSDate(serial) { if (!serial) return ""; if (typeof serial === 'string' && serial.includes('-')) return serial; if (isNaN(serial)) return serial; let date = new Date((serial - (25567 + 2)) * 86400 * 1000); return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`; }
    
    function handleFileSelect(input) {
      if (!input.files || input.files.length === 0) return;
      const file = input.files[0];
      const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
      const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear();
      let monthOpts = ""; thaiMonths.forEach((m, i) => { monthOpts += `<option value="${i+1}" ${i===currentMonth?'selected':''}>${m}</option>`; });
      let yearOpts = ""; for(let y=currentYear-1; y<=currentYear+1; y++) { yearOpts += `<option value="${y}" ${y===currentYear?'selected':''}>${y+543}</option>`; }
      Swal.fire({
          title: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ', html: `<div class="d-flex gap-2 justify-content-center"><select id="swal-month" class="form-select">${monthOpts}</select><select id="swal-year" class="form-select">${yearOpts}</select></div>`,
          showCancelButton: true, confirmButtonText: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          preConfirm: () => { const m = document.getElementById('swal-month').value.padStart(2, '0'); const y = document.getElementById('swal-year').value; return `${y}-${m}-01`; }
      }).then((result) => { if (result.isConfirmed) { if(monthPickerInstance) monthPickerInstance.setDate(result.value); processFile(file, result.value); } else { input.value = ""; } });
    }
    
    function processFile(file, selectedDate) {
      const reader = new FileReader(); Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
        if (jsonData.length < 1) { showError('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
        const records = [];
        for(let i=1; i<jsonData.length; i++) {
            const row = jsonData[i]; if(!row[0] && !row[3]) continue;
            let outstandingVal = row[8]; let derivedDeductionStatus = "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞";
            if (outstandingVal===undefined || outstandingVal===null || outstandingVal==="" || String(outstandingVal).trim()==="-" || Number(outstandingVal)===0) derivedDeductionStatus = "‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö";
            records.push({ refCode: row[0]||"", name: row[1]||"", group: row[2]||"A", idCard: String(row[3]||""), birthDate: excelDateToJSDate(row[4]), phone: row[5]||"", consentStatus: row[6]||"", amount: row[7]||"", outstanding: row[8]||"", deductionStatus: derivedDeductionStatus, channel: row[10]||"App Man", statusProcess: row[11]||"‡∏™‡πà‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", resultDate: excelDateToJSDate(row[12]), result: row[13]||"", note: row[14] || "", officerEmail: currentUser, submitDate: selectedDate });
        }
        
        google.script.run.withSuccessHandler(res => { 
            if(res.success) { 
                lastImportAdded = res.addedIds || []; 
                lastImportUpdated = res.updatedIds || []; 
                
                let addedCount = res.added !== undefined ? res.added : lastImportAdded.length;
                let updatedCount = res.updated !== undefined ? res.updated : lastImportUpdated.length;

                const lblNew = document.getElementById('lblImportNew');
                if (lblNew) lblNew.innerHTML = `‡πÉ‡∏´‡∏°‡πà <span class="badge bg-primary ms-1">${addedCount}</span>`;
                const lblUpdated = document.getElementById('lblImportUpdated');
                if (lblUpdated) lblUpdated.innerHTML = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï <span class="badge bg-warning text-dark ms-1">${updatedCount}</span>`;

                let htmlContent = `
                    <div class="text-start mt-3">
                        <div class="alert alert-info py-2 mb-2"><i class="fas fa-file-excel me-2"></i>‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: <b>${records.length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        <div class="alert alert-primary py-2 mb-2"><i class="fas fa-plus-circle me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà: <b>${addedCount}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        <div class="alert alert-warning text-dark py-2 mb-0"><i class="fas fa-edit me-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°: <b>${updatedCount}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                `;

                Swal.fire({
                    title: '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ',
                    html: htmlContent,
                    icon: 'success',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#0d6efd'
                });
                
                loadData(); 
                loadLastImportInfo(); 
            } else { 
                showError(res.message); 
            } 
            document.getElementById('importFile').value = ""; 
        }).importAnnualData(records, selectedDate);
      }; reader.readAsArrayBuffer(file);
    }
    
    function saveInlineNote(id, newNote) {
        let finalNote = newNote.trim(); if (finalNote) { const now = new Date(); const timeStr = `(${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()+543} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')})`; if (!finalNote.includes('(')) finalNote = `${timeStr} ${finalNote}`; }
        const btn = document.getElementById(`btn-save-${id}`); if(btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true; }
        google.script.run.withSuccessHandler(() => { if(btn) { btn.innerHTML = '<i class="fas fa-check text-success"></i>'; setTimeout(() => { btn.innerHTML = '<i class="fas fa-save"></i>'; btn.disabled = false; }, 1000); } const row = globalData.find(r => r.id === id); if(row) row.note = finalNote; }).updateAnnualNote(id, finalNote);
    }
    
    function loadData() {
        showLoading();
        google.script.run.withSuccessHandler(res => {
            hideLoading(); globalData = res.data; resultList = res.results||[]; ftStatusList = res.ftStatuses||[]; currentUser = res.currentUser; isUserAdmin = res.isAdmin;
            if(document.getElementById('userEmailDisplay')) document.getElementById('userEmailDisplay').textContent = currentUser;
            
            updateStats(); 
            filterTable(); 
        }).getAnnualData(document.getElementById('monthFilter').value);
    }
    
    function updateStats() {
        const total = globalData.length;
        const verified = globalData.filter(x => x.statusProcess === '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß').length;
        const linkSent = globalData.filter(x => x.statusProcess === '‡∏™‡πà‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•').length; 
        const paid = globalData.filter(x => x.deductionStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö' || x.deductionStatus === '‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').length;
        const unpaid = globalData.filter(x => x.deductionStatus === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || x.deductionStatus === '‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' || x.deductionStatus === '‡∏£‡∏≠‡∏´‡∏±‡∏Å').length;

        document.getElementById('countTotal').textContent = total;
        document.getElementById('countVerified').textContent = verified;
        document.getElementById('countLinkSent').textContent = linkSent;
        document.getElementById('countPaid').textContent = paid;
        document.getElementById('countUnpaid').textContent = unpaid;
    }
    
    function filterBySummary(type) {
        currentSummaryFilter = type;
        updateActiveSummaryUI(type);
        
        if (type === 'link_sent' || type === 'unpaid') {
            const monthVal = document.getElementById('monthFilter').value;
            if (monthVal !== "") {
                if(monthPickerInstance) monthPickerInstance.clear();
                Swal.fire({
                    title: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                    text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...',
                    icon: 'info',
                    timer: 1500,
                    showConfirmButton: false
                });
                loadData(); 
                return;
            }
        }
        filterTable();
    }

    function updateActiveSummaryUI(type) {
        document.querySelectorAll('.status-card').forEach(el => el.classList.remove('active'));
        const map = { 'total': 'card-total', 'verified': 'card-verified', 'link_sent': 'card-link-sent', 'paid': 'card-paid', 'unpaid': 'card-unpaid' };
        const id = map[type];
        if(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('active'); 
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = "";
        if(data.length === 0) { document.getElementById('noData').style.display = 'block'; return; }
        document.getElementById('noData').style.display = 'none';
        data.forEach((row, index) => {
            let tr = document.createElement('tr');
            
            if (recentlyUpdatedIds.includes(String(row.id))) {
                tr.classList.add('row-updated');
            }

            let exportIcon = row.exportStatus ? '<i class="fas fa-file-export text-success fs-5"></i>' : '<span class="text-muted">-</span>';
            
            // 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏ß‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            let amount = row.amount ? Number(row.amount).toLocaleString() : '-';
            let outstanding = row.outstanding ? Number(row.outstanding).toLocaleString() : '0';
            let deductClass = 'bg-secondary';
            if(row.deductionStatus==='‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö'||row.deductionStatus==='‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') deductClass = 'bg-success';
            else if(row.deductionStatus==='‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'||row.deductionStatus==='‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') deductClass = 'bg-danger';
            else if(row.deductionStatus==='‡∏£‡∏≠‡∏´‡∏±‡∏Å') deductClass = 'bg-warning text-dark';
            
            let paymentHtml = `
                <div class="small p-2 bg-light rounded border border-secondary-subtle">
                    <div class="d-flex justify-content-between mb-1 border-bottom pb-1">
                        <span class="text-muted">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô:</span> <span class="fw-bold">${amount}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span> <span class="text-danger fw-bold">${outstanding}</span>
                    </div>
                    <div class="text-center"><span class="badge ${deductClass} w-100">${row.deductionStatus||'-'}</span></div>
                </div>
            `;

            let groupBadge = row.group === 'A' ? 'badge-group-A' : (row.group === '‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß' ? 'badge-group-fired' : 'badge-group-default');
            let cleanIdCard = (row.idCard || "").replace(/'/g, "").trim();
            let importBadge = lastImportAdded.includes(cleanIdCard) ? `<span class="badge badge-import-new">NEW</span>` : (lastImportUpdated.includes(cleanIdCard) ? `<span class="badge badge-import-update">UPDATED</span>` : "");
            let refCodeDisplay = row.refCode ? `<a href="#" class="badge bg-light text-primary border text-decoration-none">${row.refCode}</a>` : '-';
            let deleteBtn = isUserAdmin ? `<button class="btn btn-sm btn-soft-danger ms-1" onclick="deleteItem('${row.id}')"><i class="fas fa-trash-alt"></i></button>` : '';
            
            // üåü ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢ Badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå KYC ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á) üåü
            let resBadge = '<span class="text-muted">-</span>';
            if (row.result) {
                let rc = 'bg-secondary';
                let rv = String(row.result).toLowerCase();
                
                if (rv.includes('not verified') || rv.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('kyc ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('kyc‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) {
                    rc = 'bg-danger';
                } else if (rv.includes('verified') || rv.includes('‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rv.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) {
                    rc = 'bg-success';
                } else if (rv.includes('pending') || rv.includes('‡∏£‡∏≠')) {
                    rc = 'bg-warning text-dark';
                }
                
                resBadge = `<span class="badge ${rc} text-wrap" style="max-width: 120px; line-height: 1.4;">${row.result}</span>`;
            }

            tr.innerHTML = `
                <td class="text-center align-top pt-3">${index + 1}</td>
                <td class="fw-bold align-top pt-3">${refCodeDisplay}</td>
                <td class="align-top pt-3">${row.name||'-'} ${importBadge}</td>
                <td class="text-center align-top pt-3"><span class="badge ${groupBadge}">${row.group||'-'}</span></td>
                <td class="font-monospace align-top pt-3">${row.idCard||'-'}</td>
                <td class="align-top pt-3">${row.phone||'-'}</td>
                <td class="align-top pt-3">${row.consentStatus||'-'}</td>
                <td class="align-top pt-2">${paymentHtml}</td>
                <td class="align-top pt-3"><span class="badge bg-light text-dark border">${row.channel||'-'}</span></td>
                <td class="align-top pt-3">${row.statusProcess||'-'}</td>
                <td class="align-top pt-3">${formatDate(row.resultDate)}</td>
                <td class="text-center fw-bold align-top pt-3">${resBadge}</td>
                <td style="min-width: 200px;" class="align-top pt-2">
                    <div class="input-group input-group-sm"><input type="text" class="form-control note-input" value="${row.note||''}" id="note-${row.id}" onkeydown="if(event.key==='Enter') saveInlineNote('${row.id}', this.value)"><button class="btn btn-outline-secondary rounded-end" type="button" id="btn-save-${row.id}" onclick="saveInlineNote('${row.id}', document.getElementById('note-${row.id}').value)"><i class="fas fa-save"></i></button></div>
                </td>
                <td class="text-center align-top pt-3">${exportIcon}</td>
                <td class="text-center align-top pt-3"><div class="d-flex justify-content-center align-items-center"><button class="btn btn-sm btn-soft-info" onclick='openEditModalById("${row.id}")'><i class="fas fa-edit"></i></button>${deleteBtn}</div></td>
            `;
            tbody.appendChild(tr);
        });

        if (recentlyUpdatedIds.length > 0) {
            setTimeout(() => {
                document.querySelectorAll('.row-updated').forEach(el => el.classList.remove('row-updated'));
                recentlyUpdatedIds = []; 
            }, 3000);
        }
    }

    function filterTable() {
        const txt = document.getElementById('searchInput').value.toLowerCase();
        let importFilter = "all";
        if (document.getElementById('btnImportNew').checked) importFilter = "new";
        if (document.getElementById('btnImportUpdated').checked) importFilter = "updated";
        const deductFilter = document.getElementById('deductionFilter').value;
        const groupFilter = document.getElementById('groupFilter').value;
        
        const filtered = globalData.filter(x => {
            const matchText = (x.name && x.name.toLowerCase().includes(txt)) || (x.refCode && x.refCode.toLowerCase().includes(txt)) || (x.idCard && x.idCard.includes(txt));
            let matchImport = true;
            let cleanId = (x.idCard || "").replace(/'/g, "").trim();
            if (importFilter === "new") matchImport = lastImportAdded.includes(cleanId);
            else if (importFilter === "updated") matchImport = lastImportUpdated.includes(cleanId);
            let matchDeduct = true;
            if (deductFilter === "paid") matchDeduct = (x.deductionStatus === "‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö");
            else if (deductFilter === "outstanding") matchDeduct = (x.deductionStatus === "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞");
            let matchGroup = true;
            if (groupFilter !== "") matchGroup = (x.group === groupFilter);

            let matchSummary = true;
            if (currentSummaryFilter === 'verified') matchSummary = (x.statusProcess === '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
            else if (currentSummaryFilter === 'link_sent') matchSummary = (x.statusProcess === '‡∏™‡πà‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            else if (currentSummaryFilter === 'paid') matchSummary = (x.deductionStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö' || x.deductionStatus === '‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            else if (currentSummaryFilter === 'unpaid') matchSummary = (x.deductionStatus === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || x.deductionStatus === '‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' || x.deductionStatus === '‡∏£‡∏≠‡∏´‡∏±‡∏Å');

            return matchText && matchImport && matchDeduct && matchGroup && matchSummary;
        });
        renderTable(filtered);
    }
    
    function openAddModal() { document.getElementById('dataForm').reset(); document.getElementById('recordId').value = ""; document.getElementById('modalTitle').textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)"; document.getElementById('searchSection').style.display = 'block'; document.getElementById('searchProviderInput').value = ""; document.getElementById('officerEmail').value = currentUser; document.getElementById('submitDate')._flatpickr.setDate(new Date()); updateStatusOptions(); formModal.show(); }
    
    function openEditModalById(id) {
        const item = globalData.find(x => String(x.id) === String(id));
        if(item) openEditModal(item);
    }
    
    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç "‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à" ‡πÅ‡∏ö‡∏ö Manual üåü
    function autoUpdateResultStatus() {
        const resInput = document.getElementById('result').value.trim();
        if (resInput.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || resInput.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) {
            document.getElementById('statusProcess').value = '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
            
            // ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á ‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏•
            const today = new Date();
            const d = String(today.getDate()).padStart(2, '0');
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const y = today.getFullYear();
            setFlatpickrValue('resultDate', `${y}-${m}-${d}`);
            
            // ‡πÅ‡∏™‡∏î‡∏á Toast ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏ö
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'info',
                title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
                showConfirmButton: false,
                timer: 3000
            });
        }
    }
    
    function openEditModal(item) { document.getElementById('modalTitle').textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; document.getElementById('searchSection').style.display = 'none'; document.getElementById('recordId').value = item.id; document.getElementById('refCode').value = item.refCode; document.getElementById('name').value = item.name; document.getElementById('group').value = item.group; document.getElementById('idCard').value = item.idCard; setFlatpickrValue('birthDate', item.birthDate); document.getElementById('phone').value = item.phone; document.getElementById('consentStatus').value = (item.consentStatus||"").trim(); document.getElementById('amount').value = item.amount; document.getElementById('outstanding').value = item.outstanding; document.getElementById('deductionStatus').value = item.deductionStatus; document.getElementById('channel').value = item.channel; updateStatusOptions(); document.getElementById('statusProcess').value = item.statusProcess; setFlatpickrValue('resultDate', item.resultDate); document.getElementById('result').value = item.result || ""; document.getElementById('officerEmail').value = item.officerEmail; setFlatpickrValue('submitDate', item.submitDate); document.getElementById('note').value = item.note||""; formModal.show(); }
    function updateStatusOptions() { const channel = document.getElementById('channel').value; const statusSelect = document.getElementById('statusProcess'); const currentVal = statusSelect.value; statusSelect.innerHTML = '<option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</option>'; let options = []; if (channel === 'App Man') { options = ['‡∏™‡πà‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à', '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß']; } else if (channel === '‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏á') { options = ['‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤(‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏á)', '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß']; } options.forEach(opt => { statusSelect.add(new Option(opt, opt)); }); if(options.includes(currentVal)) statusSelect.value = currentVal; }
    function saveData() { const rawNote = document.getElementById('note').value.trim(); let finalNote = rawNote; if (rawNote) { const now = new Date(); const timeStr = `(${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()+543} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')})`; if (!rawNote.includes('(')) { finalNote = `${timeStr} ${rawNote}`; } } const form = { id: document.getElementById('recordId').value, refCode: document.getElementById('refCode').value, name: document.getElementById('name').value, group: document.getElementById('group').value, idCard: document.getElementById('idCard').value, birthDate: document.getElementById('birthDate').value, phone: document.getElementById('phone').value, consentStatus: document.getElementById('consentStatus').value, amount: document.getElementById('amount').value, outstanding: document.getElementById('outstanding').value, deductionStatus: document.getElementById('deductionStatus').value, channel: document.getElementById('channel').value, statusProcess: document.getElementById('statusProcess').value, resultDate: document.getElementById('resultDate').value, result: document.getElementById('result').value, lastFollowup: "", officerEmail: document.getElementById('officerEmail').value, submitDate: document.getElementById('submitDate').value, note: finalNote }; if(!form.name || !form.group) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°', 'warning'); return; } Swal.showLoading(); google.script.run.withSuccessHandler(res => { if(res.success) { formModal.hide(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); loadData(); } else { Swal.fire('Error', res.message, 'error'); } }).saveAnnualData(form); }
    function deleteItem(id) { Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then(res => { if(res.isConfirmed) { Swal.showLoading(); google.script.run.withSuccessHandler(() => { hideLoading(); Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success'); loadData(); }).deleteAnnualData(id); } }); }
    function openExportModal() { const monthVal = document.getElementById('monthFilter').value; const dateObj = new Date(monthVal + '-01'); let displayText = "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: " + monthVal; if(monthVal && !isNaN(dateObj.getTime())) displayText = "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: " + dateObj.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' }); document.getElementById('exportYearDisplay').textContent = displayText; exportModal.show(); }
    function previewExport(groupType) { currentExportType = groupType; const year = document.getElementById('monthFilter').value; Swal.showLoading(); google.script.run.withSuccessHandler(showPreviewModal).withFailureHandler(onFailure).exportAnnualCSV(groupType, year, true); }
    function showPreviewModal(data) { Swal.close(); if (!data || data.length === 0) { Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà', 'info'); return; } const tbody = document.getElementById('previewTableBody'); tbody.innerHTML = ""; data.forEach(row => { let tr = document.createElement('tr'); tr.innerHTML = `<td>${row.refCode}</td><td>${row.name}</td><td>${row.idCard}</td><td>${row.ftStatus||'-'}</td>`; tbody.appendChild(tr); }); exportModal.hide(); previewModal.show(); }
    function confirmExport() { const year = document.getElementById('monthFilter').value; if (!currentExportType) return; previewModal.hide(); Swal.showLoading(); google.script.run.withSuccessHandler(result => { if (result.count > 0) { downloadCSV(result.content, result.filename); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `Export ${result.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success'); loadData(); } else { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); } }).withFailureHandler(onFailure).exportAnnualCSV(currentExportType, year, false); }
    function exportAnnualReport() { const year = document.getElementById('monthFilter').value; Swal.showLoading(); google.script.run.withSuccessHandler(res => { if(res.count > 0) { downloadCSV(res.content, res.filename); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success'); } else { Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info'); } }).exportAnnualReport(year); }
    function downloadCSV(csvContent, filename) { const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); }
    function formatDate(dateStr) { if(!dateStr) return "-"; if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) { const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; } if (dateStr.match(/^\d{4}-\d{2}-\d{2}T/)) { let date = new Date(dateStr); let d = date.getDate().toString().padStart(2, '0'); let m = (date.getMonth() + 1).toString().padStart(2, '0'); let y = date.getFullYear(); return `${d}/${m}/${y}`; } return dateStr; }
    function setFlatpickrValue(id, val) { const el = document.getElementById(id); if(el && el._flatpickr) { if(!val) { el._flatpickr.clear(); return; } if(val.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) { const [d, m, y] = val.split('/'); val = `${y}-${m}-${d}`; } el._flatpickr.setDate(val); } }
    function loadProviderOptions() { google.script.run.withSuccessHandler(data => { providerList = data; const dl = document.getElementById('providerOptions'); dl.innerHTML = ""; data.forEach(p => { const op = document.createElement('option'); op.value = p.code; op.label = `${p.name} (${p.idCard})`; dl.appendChild(op); }); }).getAllProviderOptions(); }
    function onProviderSelect() { const val = document.getElementById('searchProviderInput').value; if(!val) return; const found = providerList.find(p => p.code === val || p.name === val || p.idCard === val); if(found) { document.getElementById('refCode').value = found.code; document.getElementById('name').value = found.name; document.getElementById('idCard').value = found.idCard; } }
    function onFailure(error) { Swal.close(); Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error'); }

    // ==========================================
    // üåü 2. Actionable Result Modal & Smart Columns üåü
    // ==========================================
    function handleBulkUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
            Swal.fire('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .csv, .xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
            event.target.value = ''; 
            return;
        }

        const reader = new FileReader();
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                
                if (jsonData.length <= 1) {
                    Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'warning');
                    event.target.value = '';
                    return;
                }

                const headers = jsonData[0].map(h => String(h||'').toLowerCase().trim());
                let idCol = 1; 
                let statusCol = 2; 
                
                headers.forEach((h, idx) => {
                    if (h.includes('id card') || h.includes('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£') || h.includes('‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô')) idCol = idx;
                    if (h.includes('target status') || h.includes('status') || h.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞') || h.includes('‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à') || h.includes('result')) statusCol = idx;
                });

                let records = [];
                for(let i=1; i<jsonData.length; i++) {
                    records.push({
                        idCard: jsonData[i][idCol] ? String(jsonData[i][idCol]).trim() : "",
                        status: jsonData[i][statusCol] ? String(jsonData[i][statusCol]).trim() : "" 
                    });
                }
                
                Swal.close();
                confirmBulkUpload(records, file.name);
            } catch (error) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', error.message, 'error');
            }
            event.target.value = ''; 
        };
        
        reader.onerror = function() {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
            event.target.value = '';
        }
        reader.readAsArrayBuffer(file);
    }

    function confirmBulkUpload(records, fileName) {
        Swal.fire({
            title: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`,
            text: `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#198754'
        }).then((result) => {
            if (result.isConfirmed) {
                processUploadToServer(records, fileName);
            }
        });
    }

    function processUploadToServer(records, fileName) {
        showLoading();
        google.script.run
            .withSuccessHandler(res => {
                hideLoading();
                if (res.success) {
                    recentlyUpdatedIds = res.updatedIds || []; 
                    
                    document.getElementById('resSuccessCount').textContent = res.successCount;
                    document.getElementById('resFailedCount').textContent = res.failedCount;
                    
                    const tbody = document.getElementById('uploadResultTableBody');
                    tbody.innerHTML = '';
                    
                    records.forEach(rec => {
                        if(!rec.idCard && !rec.status) return;
                        
                        const cleanId = String(rec.idCard).replace(/\D/g, '');
                        const matchedItem = globalData.find(x => String(x.idCard).replace(/\D/g, '') === cleanId);
                        const nameDisplay = matchedItem ? matchedItem.name : '<span class="text-muted small"><i class="fas fa-exclamation-circle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>';
                        const idDb = matchedItem ? matchedItem.id : null;
                        
                        let rowClass = '';
                        let statusBadge = `<span class="badge bg-secondary">${rec.status}</span>`;
                        let extraAction = '';
                        let rv = rec.status.toLowerCase();
                        
                        // üåü ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Popup ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ üåü
                        if (rv.includes('not verified') || rv.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('kyc ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('kyc‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) {
                            rowClass = 'table-danger';
                            statusBadge = `<span class="badge bg-danger">${rec.status}</span>`;
                        } else if (rv.includes('verified') || rv.includes('‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rv.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) {
                            statusBadge = `<span class="badge bg-success">${rec.status}</span>`;
                            if (rv.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rv.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) {
                                extraAction = `<div class="text-success mt-1" style="font-size: 0.7rem;"><i class="fas fa-magic"></i> ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß + ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`;
                            }
                        } else if (rv.includes('pending') || rv.includes('‡∏£‡∏≠')) {
                            statusBadge = `<span class="badge bg-warning text-dark">${rec.status}</span>`;
                        }
                        
                        let resultStr = (res.updatedIds && idDb && res.updatedIds.includes(String(idDb))) 
                            ? '<span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß</span>'
                            : '<span class="text-danger fw-bold"><i class="fas fa-times-circle me-1"></i> ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>';
                            
                        let actionBtn = idDb 
                            ? `<button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="openEditModalById('${idDb}'); bootstrap.Modal.getInstance(document.getElementById('uploadResultModal')).hide();"><i class="fas fa-external-link-alt me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</button>` 
                            : '-';
                        
                        tbody.innerHTML += `
                            <tr class="${rowClass}">
                                <td class="ps-4 font-monospace">${rec.idCard}</td>
                                <td>${nameDisplay}</td>
                                <td>${statusBadge} ${extraAction}</td>
                                <td>${resultStr}</td>
                                <td class="text-center pe-4">${actionBtn}</td>
                            </tr>
                        `;
                    });
                    
                    new bootstrap.Modal(document.getElementById('uploadResultModal')).show();
                    loadData(); 
                } else {
                    showError(res.message);
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: " + err.message);
            })
            .processBulkUpdate(records, 'ANNUAL', fileName, currentUser); 
    }

    function viewHistory() {
        showLoading();
        google.script.run
            .withSuccessHandler(logs => {
                hideLoading();
                const tbody = document.getElementById('historyTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                if(!logs || logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</td></tr>';
                } else {
                    if(!window.uploadLogsData) window.uploadLogsData = [];
                    
                    logs.forEach((log, idx) => {
                        window.uploadLogsData[idx] = log;
                        
                        let failBadge = log.failedCount > 0 
                            ? `<span class="badge bg-danger rounded-pill px-2 py-1">${log.failedCount}</span>` 
                            : `<span class="text-muted small">-</span>`;
                            
                        let successBadge = log.successCount > 0
                            ? `<span class="badge bg-success rounded-pill px-2 py-1">${log.successCount}</span>`
                            : `<span class="text-muted small">-</span>`;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-4">
                                    <span class="fw-bold text-dark"><i class="far fa-clock me-2 text-muted"></i> ${log.timestamp}</span>
                                </td>
                                <td>
                                    <span class="small text-muted"><i class="fas fa-file-excel me-1 text-success"></i> ${log.fileName}</span>
                                </td>
                                <td>
                                    <span class="badge bg-light text-secondary border">${log.user}</span>
                                </td>
                                <td class="text-center">
                                    ${successBadge}
                                </td>
                                <td class="text-center">
                                    ${failBadge}
                                </td>
                                <td class="text-center pe-4">
                                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm" onclick="downloadFullLogCSV(${idx})" title="‡πÇ‡∏´‡∏•‡∏î CSV ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
                                        <i class="fas fa-download me-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                historyModal.show();
            })
            .withFailureHandler(err => { hideLoading(); showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ: " + err.message); })
            .getUploadLogs('ANNUAL'); 
    }

    function downloadFullLogCSV(idx) {
        const log = window.uploadLogsData[idx];
        if(!log) return;
        
        let csvContent = "ID Card,Target Status,Update Result,Reason\n";
        
        if(log.successItems && log.successItems.length > 0) {
            log.successItems.forEach(item => {
                csvContent += `="${item.idCard || ''}","${item.status || ''}","SUCCESS","Updated Successfully"\n`;
            });
        }
        
        if(log.failedItems && log.failedItems.length > 0) {
            log.failedItems.forEach(item => {
                csvContent += `="${item.idCard || ''}","${item.status || ''}","FAILED","${item.reason || ''}"\n`;
            });
        }

        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        const safeTime = String(log.timestamp).replace(/[:\/ ]/g, '_');
        link.setAttribute("download", `Annual_Update_Details_${safeTime}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
  </script>
</body>
</html>
