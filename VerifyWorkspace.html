<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Verification Workspace)</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

  <?!= include('_Styles'); ?>

  <style>
    .status-card { transition: all 0.2s ease; cursor: pointer; background: #fff; border-radius: 12px; border: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
    .status-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .status-card h3 { font-size: 1.8rem; margin-bottom: 0; font-weight: 700; }
    
    .status-card.active { box-shadow: 0 4px 12px rgba(0,0,0,0.1); background-color: #f8fcfd; transform: translateY(-2px); }
    .status-card.active.border-start-primary { border-left: 4px solid #0d6efd !important; }
    .status-card.active.border-start-success { border-left: 4px solid #198754 !important; }
    .status-card.active.border-start-warning { border-left: 4px solid #ffc107 !important; }
    .status-card.active.border-start-danger { border-left: 4px solid #dc3545 !important; }
    .status-card.active.border-start-info { border-left: 4px solid #0dcaf0 !important; }

    .border-start-primary { border-left: 4px solid #0d6efd !important; }
    .border-start-success { border-left: 4px solid #198754 !important; }
    .border-start-warning { border-left: 4px solid #ffc107 !important; }
    .border-start-danger { border-left: 4px solid #dc3545 !important; }
    .border-start-info { border-left: 4px solid #0dcaf0 !important; }

    .nav-pills .nav-link { background-color: white; color: #6c757d; border: 1px solid #eef2f5; font-weight: 600; transition: all 0.2s; }
    .nav-pills .nav-link:hover { background-color: #f8f9fa; transform: translateY(-2px); }
    .nav-pills .nav-link.active { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; border-color: #0d6efd; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.1) !important; }
    .nav-pills .nav-link.active .badge { background-color: #0d6efd !important; color: white !important; }

    .row-updated { background-color: #d1e7dd !important; transition: background-color 2s ease; }
    #bulkUploadStatusFile, #importFile { display: none; }
    
    .note-input { border: 1px solid #e9ecef; border-radius: 4px; padding: 4px 10px; font-size: 0.85rem; background-color: #f8f9fa; transition: all 0.3s; }
    .note-input:focus { border-color: var(--ci-primary); outline: none; background-color: #fff; box-shadow: none; z-index: 0; }
    .note-input.is-valid { border-color: #198754; background-color: #e8f5e9; }
    
    .hover-bg-primary:hover { background-color: #e9ecef !important; color: #0d6efd !important; }
  </style>
</head>
<body>

  <?!= include('_Sidebar'); ?>

  <div class="main-content">
    <?!= include('_Navbar'); ?>
    
    <div class="container-fluid">
        <!-- üåü Header & Bulk Actions üåü -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h4 class="mb-0 fw-bold text-secondary">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Verification)</h4>
                <small class="text-muted">‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà (Master) ‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Annual)</small>
            </div>
            <div class="d-flex gap-2">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ó‡πá‡∏ö Annual) -->
                <button class="btn btn-info text-white rounded-pill px-3 shadow-sm fw-bold d-none" id="btnImportAnnual" onclick="document.getElementById('importFile').click()" title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å">
                    <i class="fas fa-file-import me-1"></i> ‡πÅ‡∏ô‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                </button>
                <input type="file" id="importFile" accept=".xlsx, .xls, .csv" onchange="handleFileSelect(this)">

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (App Man) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏£‡∏∞‡∏ö‡∏ö -->
                <button class="btn btn-success text-white rounded-pill px-4 shadow-sm fw-bold" onclick="document.getElementById('bulkUploadStatusFile').click()" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á Master ‡πÅ‡∏•‡∏∞ Annual">
                    <i class="fas fa-bolt me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å App Man
                </button>
                <input type="file" id="bulkUploadStatusFile" accept=".xlsx, .xls, .csv" onchange="handleUnifiedBulkUpload(event)">
                
                <button class="btn btn-soft-primary rounded-pill px-3 shadow-sm" onclick="openExportModal()">
                    <i class="fas fa-file-export me-1"></i> Export CSV
                </button>
                <button class="btn btn-outline-secondary rounded-pill px-3 shadow-sm fw-bold" onclick="viewHistory()">
                    <i class="fas fa-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                </button>
            </div>
        </div>

        <!-- üåü Smart Tabs üåü -->
        <ul class="nav nav-pills mb-4" id="verifyTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active rounded-pill px-4 me-2 shadow-sm" id="tab-master" data-bs-toggle="tab" type="button" onclick="switchTab('MASTER')">
                    <i class="fas fa-user-shield me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà (Master) <span class="badge bg-secondary ms-1" id="badge-master-count">0</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill px-4 shadow-sm" id="tab-annual" data-bs-toggle="tab" type="button" onclick="switchTab('ANNUAL')">
                    <i class="fas fa-calendar-check me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Annual) <span class="badge bg-secondary ms-1" id="badge-annual-count">0</span>
                </button>
            </li>
        </ul>

        <!-- üåü Dynamic Status Cards üåü -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3 mb-4" id="statsContainer">
            <!-- JS will inject cards here based on active tab -->
        </div>

        <!-- üåü Dynamic Filters üåü -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="far fa-calendar-alt text-primary"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" id="monthFilter" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." readonly>
                        <button class="btn btn-light border border-start-0 text-muted" type="button" onclick="clearDateFilter()" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                  </div>
                  
                  <div class="col-md-2">
                     <label class="form-label small text-muted fw-bold">‡∏®‡∏π‡∏ô‡∏¢‡πå</label>
                     <select class="form-select" id="centerFilter" onchange="filterTable()"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
                  </div>
                  
                  <!-- Filter specifically for Master -->
                  <div class="col-md-2 filter-master-only">
                     <label class="form-label small text-muted fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FT</label>
                     <select class="form-select" id="statusFilterMaster" onchange="filterTable()">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="Verified">Verified</option>
                        <option value="Not Verified">Not Verified</option>
                        <option value="Pending Result">Pending Result</option>
                        <option value="In Progress">In Progress</option>
                     </select>
                  </div>

                  <!-- Filters specifically for Annual -->
                  <div class="col-md-2 filter-annual-only d-none">
                     <label class="form-label small text-muted fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à</label>
                     <select class="form-select" id="statusProcessFilterAnnual" onchange="filterTable()">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå/‡∏£‡∏≠‡∏ú‡∏•</option>
                     </select>
                  </div>
                  <div class="col-md-2 filter-annual-only d-none">
                     <label class="form-label small text-muted fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                     <select class="form-select" id="paymentFilterAnnual" onchange="filterTable()">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß/‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                        <option value="unpaid">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞/‡∏£‡∏≠‡∏´‡∏±‡∏Å</option>
                     </select>
                  </div>
                  
                  <!-- Import Results Filter (Annual Only) -->
                  <div class="col-md-12 filter-annual-only d-none mt-3">
                      <div class="d-flex align-items-center bg-light p-2 rounded border">
                         <span class="small fw-bold text-muted ms-2 text-nowrap me-3"><i class="fas fa-history me-1"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ:</span>
                         <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="importFilter" id="btnImportAll" value="all" autocomplete="off" checked onchange="filterTable()">
                            <label class="btn btn-outline-secondary border-0 rounded-pill me-1 px-3" for="btnImportAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                            
                            <input type="radio" class="btn-check" name="importFilter" id="btnImportNew" value="new" autocomplete="off" onchange="filterTable()">
                            <label class="btn btn-outline-primary border-0 rounded-pill me-1 px-3" for="btnImportNew" id="lblImportNew">‡πÉ‡∏´‡∏°‡πà</label>
                            
                            <input type="radio" class="btn-check" name="importFilter" id="btnImportUpdated" value="updated" autocomplete="off" onchange="filterTable()">
                            <label class="btn btn-outline-warning text-dark border-0 rounded-pill px-3" for="btnImportUpdated" id="lblImportUpdated">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</label>
                         </div>
                      </div>
                  </div>

                  <div class="col-md-3 flex-grow-1">
                    <label class="form-label small text-muted fw-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                      <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£..." onkeyup="filterTable()">
                    </div>
                  </div>
                  <div class="col-md-2 text-end">
                    <button class="btn btn-primary-theme w-100 rounded-pill shadow-sm" onclick="openAddModal()">
                      <i class="fas fa-plus me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                  </div>
                </div>
            </div>
        </div>

        <!-- üåü Dynamic Data Table üåü -->
        <div class="table-container">
          <div class="table-responsive">
              <table class="table table-hover align-middle" id="dataTable">
                <thead class="table-light" id="tableHead">
                  <!-- JS Injects Headers here -->
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
          </div>
          <div id="noDataMessage" class="text-center py-5 text-muted" style="display:none;">
            <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </div>
        </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- MODALS AREA -->
  <!-- ============================================== -->

  <!-- Modal: Form Master -->
  <div class="modal fade" id="formModalMaster" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-white border-bottom-0 pb-0">
          <h5 class="modal-title fw-bold text-primary"><i class="fas fa-user-shield me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà (Master)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-3">
          <form id="dataFormMaster">
            <input type="hidden" id="m_recordId">
            <div class="row g-3">
              <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</label><input type="text" class="form-control" id="m_code"></div>
              <div class="col-md-8"><label class="form-label small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label><input type="text" class="form-control fw-bold" id="m_name" required></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.</label><input type="text" class="form-control" id="m_idCard" maxlength="17" oninput="formatIdCard(this)"></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="text" class="form-control" id="m_phone"></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°</label><input type="text" class="form-control datepicker-input" id="m_trainingDate"></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label><input type="text" class="form-control datepicker-input" id="m_submitDate"></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡∏®‡∏π‡∏ô‡∏¢‡πå (Center)</label><select class="form-select" id="m_center"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå...</option></select></div>
              <div class="col-md-6"><label class="form-label small fw-bold text-muted">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (Officer)</label><input type="text" class="form-control bg-light" id="m_officer" readonly></div>
              
              <div class="col-12 mt-3 pt-3 border-top bg-light p-3 rounded-3">
                  <h6 class="text-primary fw-bold mb-3 small">‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h6>
                  <div class="row g-3">
                      <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•</label><input type="text" class="form-control datepicker-input" id="m_resultDate"></div>
                      <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏à‡∏≤‡∏Å App Man)</label>
                        <select class="form-select" id="m_result" onchange="autoUpdateMasterStatus()">
                            <option value="">- ‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -</option>
                            <option value="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>
                            <option value="‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>
                            <option value="KYC ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô">KYC ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option>
                            <option value="‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à">‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FT</label>
                        <select class="form-select" id="m_ftStatus">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option><option value="Verified">Verified</option><option value="Not Verified">Not Verified</option><option value="Pending Result">Pending Result</option><option value="In Progress">In Progress</option>
                        </select>
                      </div>
                      <div class="col-12"><label class="form-label small fw-bold text-muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea class="form-control" id="m_note" rows="2"></textarea></div>
                  </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
          <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="saveMasterData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Form Annual -->
  <div class="modal fade" id="formModalAnnual" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-white border-bottom-0 pb-0">
          <h5 class="modal-title fw-bold text-warning text-dark"><i class="fas fa-calendar-check me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Annual)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-3">
          <form id="dataFormAnnual">
            <input type="hidden" id="a_recordId">
            <div class="row g-3 mb-4">
               <div class="col-md-3"><label class="form-label small fw-bold text-muted">‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</label><input type="text" class="form-control bg-light" id="a_refCode"></div>
               <div class="col-md-5"><label class="form-label small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label><input type="text" class="form-control fw-bold bg-light" id="a_name" required></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏Å‡∏•‡∏∏‡πà‡∏°</label><input type="text" class="form-control" id="a_group"></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.</label><input type="text" class="form-control" id="a_idCard" oninput="formatIdCard(this)"></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input type="text" class="form-control datepicker-input" id="a_birthDate"></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" class="form-control" id="a_phone"></div>
            </div>

            <div class="p-3 bg-light rounded mb-4 border">
                <h6 class="text-secondary fw-bold mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h6>
                <div class="row g-3">
                   <div class="col-md-3"><label class="form-label small">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô?</label><input type="text" class="form-control" id="a_consentStatus"></div>
                   <div class="col-md-3"><label class="form-label small">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à</label><input type="number" class="form-control" id="a_amount" placeholder="0"></div>
                   <div class="col-md-3"><label class="form-label small text-danger">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</label><input type="number" class="form-control border-danger" id="a_outstanding" placeholder="0"></div>
                   <div class="col-md-3"><label class="form-label small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</label><select class="form-select fw-bold" id="a_deductionStatus"><option value="">- ‡∏£‡∏∞‡∏ö‡∏∏ -</option><option value="‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö</option><option value="‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</option><option value="‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à">‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option value="‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à">‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option value="‡∏£‡∏≠‡∏´‡∏±‡∏Å">‡∏£‡∏≠‡∏´‡∏±‡∏Å</option></select></div>
                </div>
            </div>

            <div class="row g-3">
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select class="form-select" id="a_channel"><option value="App Man">App Man</option><option value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏á">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏á</option></select></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à</label><select class="form-select" id="a_statusProcess"><option value="‡∏™‡πà‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option><option value="‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à">‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</option><option value="‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option></select></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•</label><input type="text" class="form-control datepicker-input" id="a_resultDate"></div>
               <div class="col-md-4"><label class="form-label small fw-bold text-muted">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (‡∏à‡∏≤‡∏Å App Man)</label><input type="text" class="form-control bg-light" id="a_result" onchange="autoUpdateAnnualStatus()" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß"></div>
               <div class="col-md-8"><label class="form-label small fw-bold text-muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" class="form-control" id="a_note"></div>
               <div class="d-none"><input type="text" id="a_officerEmail"><input type="text" class="form-control datepicker" id="a_submitDate"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0 bg-white">
          <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
          <button type="button" class="btn btn-warning text-dark rounded-pill px-4 fw-bold shadow-sm" onclick="saveAnnualData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center pb-5 pt-0">
          <div class="mb-3 text-primary"><i class="fas fa-file-csv fa-3x"></i></div>
          <h5 class="fw-bold">Export CSV</h5>
          <p class="text-muted small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export</p>
          <p class="badge bg-light text-primary mb-4 fs-6" id="exportMonthDisplay"></p>
          <div id="exportOptionsContainer" class="d-grid gap-2 col-10 mx-auto">
              <!-- JS Injects buttons here based on active tab -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light"><h5 class="modal-title fw-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Export</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <table class="table table-sm table-bordered">
                <thead class="table-light"><tr><th>Code</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                <tbody id="previewTableBody"></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="button" class="btn btn-primary-theme" id="confirmExportBtn" onclick="confirmExport()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Download</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üåü Unified Upload Result Modal üåü -->
  <div class="modal fade" id="uploadResultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-dark text-white border-bottom-0">
          <h5 class="modal-title fw-bold"><i class="fas fa-clipboard-check me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (Master & Annual)</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
            <div class="d-flex bg-light p-3 border-bottom justify-content-around">
                <div class="text-center"><h3 class="text-primary fw-bold mb-0" id="resMasterCount">0</h3><small class="text-muted fw-bold">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà</small></div>
                <div class="text-center"><h3 class="text-warning text-dark fw-bold mb-0" id="resAnnualCount">0</h3><small class="text-muted fw-bold">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</small></div>
                <div class="text-center"><h3 class="text-danger fw-bold mb-0" id="resFailedCount">0</h3><small class="text-muted fw-bold">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß / ‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö</small></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light"><tr><th class="ps-4">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</th><th>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</th></tr></thead>
                    <tbody id="uploadResultTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer bg-light border-top-0">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light border-bottom-0">
          <h5 class="modal-title fw-bold text-secondary"><i class="fas fa-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å App Man</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light"><tr><th class="ps-4">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="text-center">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th><th class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</th><th class="text-center pe-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
        <div class="modal-footer bg-light border-top-0">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üåü Log Details Modal (Popup ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) üåü -->
  <div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-dark text-white border-bottom-0">
          <h5 class="modal-title fw-bold"><i class="fas fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">‡∏£‡∏´‡∏±‡∏™</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</th>
                            <th>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody id="logDetailsTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer bg-light border-top-0">
            <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <?!= include('_Scripts'); ?>
  
  <script>
    let globalDataMaster = [], globalDataAnnual = [];
    let centersList = [];
    let currentUser = "", isUserAdmin = false;
    let monthPickerInstance;
    
    // Core state
    let currentTab = 'MASTER'; 
    let recentlyUpdatedMaster = [];
    let recentlyUpdatedAnnual = [];
    
    let lastImportAdded = [];
    let lastImportUpdated = [];
    let currentExportStatus = "";

    // Modals
    let formModalMaster, formModalAnnual, uploadResultModal, historyModal, logDetailsModal;
    let exportModal, previewModal;

    window.onload = function() {
      formModalMaster = new bootstrap.Modal(document.getElementById('formModalMaster'));
      formModalAnnual = new bootstrap.Modal(document.getElementById('formModalAnnual'));
      uploadResultModal = new bootstrap.Modal(document.getElementById('uploadResultModal'));
      historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
      logDetailsModal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
      exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
      previewModal = new bootstrap.Modal(document.getElementById('previewModal'));

      const today = new Date();
      monthPickerInstance = flatpickr("#monthFilter", { 
          plugins: [ new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "F Y", theme: "light" }) ], 
          locale: "th", defaultDate: today, onChange: function() { loadData(); } 
      });
      flatpickr(".datepicker-input", { dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", locale: "th" });

      loadData();
    };
    
    // üåü Helper Function: ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Data ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß) üåü
    function getProviderInfo(idCard) {
        let cleanId = String(idCard).replace(/\D/g, '');
        let name = "-";
        let code = "-";
        
        let found = globalDataAnnual.find(x => String(x.idCard).replace(/\D/g, '') === cleanId);
        if(found) {
            name = found.name;
            code = found.refCode;
        } else {
            found = globalDataMaster.find(x => String(x.idCard).replace(/\D/g, '') === cleanId);
            if(found) {
                name = found.name;
                code = found.code;
            }
        }
        return { name, code };
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Popup ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏° üåü
    function showFullText(tab, id, field) {
        let data = tab === 'MASTER' ? globalDataMaster : globalDataAnnual;
        let item = data.find(x => String(x.id) === String(id));
        if(!item) return;
        
        let title = field === 'result' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à' : '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏';
        let text = item[field] || '-';
        
        Swal.fire({
            title: `<span class="fs-5">${title}</span>`,
            html: `<div class="text-start bg-light p-3 rounded border text-break" style="max-height: 300px; overflow-y: auto; font-size: 0.95rem;">${text.replace(/\n/g, '<br>')}</div>`,
            icon: 'info',
            confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',
            confirmButtonColor: '#6c757d'
        });
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Annual) üåü
    function editFullNotePopup(id) {
        const inputEl = document.getElementById(`note-${id}`);
        const currentNote = inputEl ? inputEl.value : '';
        
        Swal.fire({
            title: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',
            input: 'textarea',
            inputValue: currentNote,
            inputPlaceholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...',
            inputAttributes: { 'rows': 6 },
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#0d6efd',
            customClass: { input: 'bg-light border' }
        }).then((result) => {
            if (result.isConfirmed && result.value !== currentNote) {
                if (inputEl) {
                    inputEl.value = result.value;
                    saveInlineNote(id, result.value);
                }
            }
        });
    }
    
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.filter-master-only, .filter-annual-only').forEach(el => el.classList.add('d-none'));
        
        if (tab === 'MASTER') {
            document.querySelectorAll('.filter-master-only').forEach(el => el.classList.remove('d-none'));
            document.getElementById('btnImportAnnual').classList.add('d-none');
        } else {
            document.querySelectorAll('.filter-annual-only').forEach(el => el.classList.remove('d-none'));
            document.getElementById('btnImportAnnual').classList.remove('d-none');
        }
        
        updateStats();
        filterTable();
    }

    let loadCount = 0;
    function loadData() {
        showLoading();
        loadCount = 0;
        const filterVal = document.getElementById('monthFilter').value;
        
        // Fetch Master
        google.script.run.withSuccessHandler(res => {
            globalDataMaster = res.data || [];
            centersList = res.centers || [];
            currentUser = res.currentUser;
            isUserAdmin = res.isAdmin;
            checkLoadComplete();
        }).getInitialData(filterVal);
        
        // Fetch Annual
        google.script.run.withSuccessHandler(res => {
            globalDataAnnual = res.data || [];
            checkLoadComplete();
        }).getAnnualData(filterVal);
    }

    function checkLoadComplete() {
        loadCount++;
        if(loadCount === 2) {
            hideLoading();
            
            const centerSel = document.getElementById('centerFilter');
            const currentC = centerSel.value;
            centerSel.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            centersList.forEach(c => centerSel.add(new Option(c, c)));
            centerSel.value = currentC;
            
            const selMaster = document.getElementById('m_center');
            selMaster.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
            centersList.forEach(c => selMaster.add(new Option(c, c)));

            updateStats();
            filterTable();
        }
    }

    function clearDateFilter() {
        if(monthPickerInstance) monthPickerInstance.clear();
        loadData();
    }

    function updateStats() {
        const container = document.getElementById('statsContainer');
        document.getElementById('badge-master-count').textContent = globalDataMaster.length;
        document.getElementById('badge-annual-count').textContent = globalDataAnnual.length;

        if (currentTab === 'MASTER') {
            const tot = globalDataMaster.length;
            const ver = globalDataMaster.filter(x => x.ftStatus === 'Verified').length;
            const pen = globalDataMaster.filter(x => x.ftStatus === 'Pending Result' || x.ftStatus === 'In Progress').length;
            const not = globalDataMaster.filter(x => x.ftStatus === 'Not Verified').length;
            container.innerHTML = `
                <div class="col"><div class="card status-card border-start-primary p-3 active" onclick="filterByCard('MASTER', '')"><small class="text-muted fw-bold">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-primary">${tot}</h3><i class="fas fa-users fs-4 opacity-25"></i></div></div></div>
                <div class="col"><div class="card status-card border-start-success p-3" onclick="filterByCard('MASTER', 'Verified')"><small class="text-muted fw-bold">‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-success">${ver}</h3><i class="fas fa-check-circle fs-4 opacity-25"></i></div></div></div>
                <div class="col"><div class="card status-card border-start-warning p-3" onclick="filterByCard('MASTER', 'Pending Result')"><small class="text-muted fw-bold">‡∏£‡∏≠‡∏ú‡∏•</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-warning">${pen}</h3><i class="fas fa-clock fs-4 opacity-25"></i></div></div></div>
                <div class="col"><div class="card status-card border-start-danger p-3" onclick="filterByCard('MASTER', 'Not Verified')"><small class="text-muted fw-bold">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô/‡∏Ñ‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-danger">${not}</h3><i class="fas fa-times-circle fs-4 opacity-25"></i></div></div></div>
            `;
        } else {
            const tot = globalDataAnnual.length;
            const ver = globalDataAnnual.filter(x => x.statusProcess === '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß').length;
            const pen = globalDataAnnual.filter(x => x.statusProcess === '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' || x.statusProcess === '‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à').length;
            const unpaid = globalDataAnnual.filter(x => x.deductionStatus === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || x.deductionStatus === '‡∏£‡∏≠‡∏´‡∏±‡∏Å' || x.deductionStatus === '‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').length;
            container.innerHTML = `
                <div class="col"><div class="card status-card border-start-primary p-3 active" onclick="filterByCard('ANNUAL', '', '')"><small class="text-muted fw-bold">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-primary">${tot}</h3><i class="fas fa-users fs-4 opacity-25"></i></div></div></div>
                <div class="col"><div class="card status-card border-start-success p-3" onclick="filterByCard('ANNUAL', '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '')"><small class="text-muted fw-bold">‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-success">${ver}</h3><i class="fas fa-check-circle fs-4 opacity-25"></i></div></div></div>
                <div class="col"><div class="card status-card border-start-info p-3" onclick="filterByCard('ANNUAL', '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '')"><small class="text-muted fw-bold">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß/‡∏£‡∏≠‡∏ú‡∏•</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-info">${pen}</h3><i class="fas fa-paper-plane fs-4 opacity-25"></i></div></div></div>
                <div class="col"><div class="card status-card border-start-danger p-3" onclick="filterByCard('ANNUAL', '', 'unpaid')"><small class="text-muted fw-bold">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</small><div class="d-flex justify-content-between align-items-center mt-1"><h3 class="text-danger">${unpaid}</h3><i class="fas fa-wallet fs-4 opacity-25"></i></div></div></div>
            `;
        }
    }

    function filterByCard(module, status, payment) {
        document.querySelectorAll('.status-card').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        if (module === 'MASTER') {
            document.getElementById('statusFilterMaster').value = status;
            
            if(status === 'Pending Result' || status === 'Not Verified') {
                if(document.getElementById('monthFilter').value !== "") {
                    monthPickerInstance.clear();
                    Swal.fire({ toast: true, position: 'top', icon: 'info', title: '‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á', showConfirmButton: false, timer: 2000 });
                    loadData(); return;
                }
            }
        } else {
            document.getElementById('statusProcessFilterAnnual').value = status;
            document.getElementById('paymentFilterAnnual').value = payment;
            
            if(status === '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' || payment === 'unpaid') {
                if(document.getElementById('monthFilter').value !== "") {
                    monthPickerInstance.clear();
                    Swal.fire({ toast: true, position: 'top', icon: 'info', title: '‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á', showConfirmButton: false, timer: 2000 });
                    loadData(); return;
                }
            }
        }
        filterTable();
    }

    function formatIdCard(idStr) {
        let v = String(idStr).replace(/\D/g, '');
        if(!v || v.length !== 13) return idStr || '-';
        return `${v.substring(0,1)}-${v.substring(1,5)}-${v.substring(5,10)}-${v.substring(10,12)}-${v.substring(12,13)}`;
    }

    function filterTable() {
        const txt = document.getElementById('searchInput').value.toLowerCase();
        const center = document.getElementById('centerFilter').value;
        
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";

        if (currentTab === 'MASTER') {
            thead.innerHTML = `<tr><th class="text-center">#</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.</th><th>‡∏®‡∏π‡∏ô‡∏¢‡πå</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•</th><th class="bg-primary bg-opacity-10 text-center">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FT</th><th style="max-width: 150px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th class="text-center">Export</th><th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>`;
            
            const ftStatus = document.getElementById('statusFilterMaster').value;
            const filtered = globalDataMaster.filter(x => {
                const matchTxt = (String(x.name) + String(x.idCard) + String(x.code)).toLowerCase().includes(txt);
                const matchCen = center === "" || x.center === center;
                const matchSta = ftStatus === "" || x.ftStatus === ftStatus;
                return matchTxt && matchCen && matchSta;
            });

            if(filtered.length === 0) { document.getElementById('noDataMessage').style.display='block'; return; }
            document.getElementById('noDataMessage').style.display='none';

            filtered.forEach((item, index) => {
                let tr = document.createElement('tr');
                if (recentlyUpdatedMaster.includes(String(item.id))) tr.classList.add('row-updated');
                
                let bs = 'bg-secondary';
                if(item.ftStatus === 'Verified') bs = 'bg-success';
                else if(item.ftStatus === 'Not Verified') bs = 'bg-danger';
                else if(item.ftStatus === 'Pending Result') bs = 'bg-warning text-dark';
                
                // üåü Logic ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (Master)
                let displayResMaster = item.result || '-';
                let resBadgeMaster = '';
                if (displayResMaster !== '-') {
                    let isDanger = displayResMaster.includes('‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥') && !displayResMaster.includes('‡πÑ‡∏°‡πà‡∏û‡∏ö');
                    let badgeClass = isDanger ? 'bg-danger' : 'bg-secondary';
                    if (displayResMaster.length > 25) {
                        resBadgeMaster = `<span class="badge ${badgeClass} text-wrap text-start" style="max-width: 140px; line-height: 1.4; cursor:pointer;" onclick="showFullText('MASTER', '${item.id}', 'result')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">${displayResMaster.substring(0,25)}... <i class="fas fa-search-plus ms-1"></i></span>`;
                    } else {
                        resBadgeMaster = `<span class="badge ${badgeClass} text-wrap text-start" style="max-width: 140px; line-height: 1.4;">${displayResMaster}</span>`;
                    }
                } else {
                    resBadgeMaster = `<span class="text-muted">-</span>`;
                }

                // üåü Logic ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Master)
                let safeNoteMaster = (item.note || '-').replace(/"/g, '&quot;');
                let noteMaster = item.note || '-';
                if (noteMaster.length > 30) {
                    noteMaster = `<span class="d-inline-block text-truncate text-primary" style="max-width: 180px; cursor:pointer;" onclick="showFullText('MASTER', '${item.id}', 'note')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"><i class="fas fa-comment-dots me-1"></i>${safeNoteMaster}</span>`;
                }
                
                let exportIcon = item.exportStatus ? `<i class="fas fa-file-export text-success fs-5" title="Exported"></i>` : `<span class="text-muted">-</span>`;
                
                // üåü ‡πÄ‡∏û‡∏¥‡πà‡∏° Deep Link ‡∏ó‡∏µ‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Master
                let codeDisplayMaster = item.code ? `<a href="https://admin-test.beneat.co/professional/${item.code}/profile" target="_blank" class="badge bg-primary-subtle text-primary text-decoration-none border">${item.code}</a>` : `<span class="badge bg-light text-muted border">-</span>`;

                // üåü ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (Master)
                let deleteBtn = isUserAdmin ? `<button class="btn btn-sm btn-soft-danger ms-1" onclick="deleteMasterItem('${item.id}')" title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="fas fa-trash-alt"></i></button>` : '';

                tr.innerHTML = `
                    <td class="text-center align-middle">${index+1}</td>
                    <td class="align-middle">${codeDisplayMaster}</td>
                    <td class="align-middle">${item.trainingDate||'-'}</td>
                    <td class="fw-bold align-middle">${item.name}</td>
                    <td class="font-monospace align-middle">${formatIdCard(item.idCard)}</td>
                    <td class="align-middle">${item.center||'-'}</td>
                    <td class="align-middle">${item.resultDate||'-'}</td>
                    <td class="bg-primary bg-opacity-10 fw-bold align-middle text-center">${resBadgeMaster}</td>
                    <td class="align-middle"><span class="badge ${bs}">${item.ftStatus||'-'}</span></td>
                    <td class="align-middle small">${noteMaster}</td>
                    <td class="text-center align-middle">${exportIcon}</td>
                    <td class="text-center align-middle"><div class="d-flex justify-content-center align-items-center"><button class="btn btn-sm btn-soft-primary" onclick="openEditModal('${item.id}')"><i class="fas fa-edit"></i></button>${deleteBtn}</div></td>
                `;
                tbody.appendChild(tr);
            });
            if (recentlyUpdatedMaster.length > 0) setTimeout(() => { document.querySelectorAll('.row-updated').forEach(el => el.classList.remove('row-updated')); recentlyUpdatedMaster = []; }, 3000);

        } else {
            // ANNUAL
            thead.innerHTML = `<tr><th class="text-center">#</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="text-center">‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏•</th><th class="text-center bg-warning bg-opacity-10 border-warning">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</th><th style="min-width: 250px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th class="text-center">Export</th><th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>`;
            
            const spStatus = document.getElementById('statusProcessFilterAnnual').value;
            const payStatus = document.getElementById('paymentFilterAnnual').value;
            
            let impFilter = "all";
            const radioNodeList = document.getElementsByName('importFilter');
            for(let i=0; i<radioNodeList.length; i++) {
                 if(radioNodeList[i].checked) { impFilter = radioNodeList[i].value; break; }
            }

            const filtered = globalDataAnnual.filter(x => {
                const matchTxt = (String(x.name) + String(x.idCard) + String(x.refCode)).toLowerCase().includes(txt);
                const matchCen = center === "" || x.center === center; 
                const matchSp = spStatus === "" || x.statusProcess === spStatus;
                
                let matchPay = true;
                if(payStatus === 'paid') matchPay = (x.deductionStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö' || x.deductionStatus === '‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                else if (payStatus === 'unpaid') matchPay = (x.deductionStatus === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' || x.deductionStatus === '‡∏£‡∏≠‡∏´‡∏±‡∏Å' || x.deductionStatus === '‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

                let matchImport = true;
                let cleanId = (x.idCard || "").replace(/'/g, "").trim();
                if (impFilter === "new") matchImport = lastImportAdded.includes(cleanId);
                else if (impFilter === "updated") matchImport = lastImportUpdated.includes(cleanId);

                return matchTxt && matchCen && matchSp && matchPay && matchImport;
            });

            if(filtered.length === 0) { document.getElementById('noDataMessage').style.display='block'; return; }
            document.getElementById('noDataMessage').style.display='none';

            filtered.forEach((row, index) => {
                let tr = document.createElement('tr');
                if (recentlyUpdatedAnnual.includes(String(row.id))) tr.classList.add('row-updated');
                
                let amount = row.amount ? Number(row.amount).toLocaleString() : '-';
                let outstanding = row.outstanding ? Number(row.outstanding).toLocaleString() : '0';
                let deductClass = 'bg-secondary';
                if(row.deductionStatus==='‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö'||row.deductionStatus==='‡∏´‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') deductClass = 'bg-success';
                else if(row.deductionStatus==='‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'||row.deductionStatus==='‡∏´‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') deductClass = 'bg-danger';
                else if(row.deductionStatus==='‡∏£‡∏≠‡∏´‡∏±‡∏Å') deductClass = 'bg-warning text-dark';
                
                let paymentHtml = `
                    <div class="small p-2 bg-light rounded border border-secondary-subtle">
                        <div class="d-flex justify-content-between mb-1 border-bottom pb-1">
                            <span class="text-muted">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô:</span> <span class="fw-bold">${amount}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span> <span class="text-danger fw-bold">${outstanding}</span>
                        </div>
                        <div class="text-center"><span class="badge ${deductClass} w-100">${row.deductionStatus||'-'}</span></div>
                    </div>
                `;

                let groupBadgeClass = 'bg-secondary';
                let grp = String(row.group || '').trim();
                if (grp === 'A') groupBadgeClass = 'bg-success';
                else if (grp === 'B') groupBadgeClass = 'bg-primary';
                else if (grp === 'C') groupBadgeClass = 'bg-info text-dark';
                else if (grp === 'H') groupBadgeClass = 'bg-warning text-dark';
                else if (grp === '‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß') groupBadgeClass = 'bg-danger';

                let cleanIdCard = (row.idCard || "").replace(/'/g, "").trim();
                let importBadge = lastImportAdded.includes(cleanIdCard) ? `<span class="badge bg-primary ms-1" style="font-size:0.65rem;">NEW</span>` : (lastImportUpdated.includes(cleanIdCard) ? `<span class="badge bg-warning text-dark ms-1" style="font-size:0.65rem;">UPDATED</span>` : "");
                
                // üåü ‡πÄ‡∏û‡∏¥‡πà‡∏° Deep Link ‡∏ó‡∏µ‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Annual
                let refCodeDisplay = row.refCode ? `<a href="https://admin-test.beneat.co/professional/${row.refCode}/profile" target="_blank" class="badge bg-warning-subtle text-warning-emphasis border text-decoration-none">${row.refCode}</a>` : '-';
                
                // üåü Logic ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (Annual)
                let resBadge = '<span class="text-muted">-</span>';
                if (row.result) {
                    let rc = 'bg-secondary';
                    let rv = String(row.result).toLowerCase();
                    if (rv.includes('not verified') || rv.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('kyc ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) rc = 'bg-danger';
                    else if (rv.includes('verified') || rv.includes('‡∏ú‡πà‡∏≤‡∏ô') || rv.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rv.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) rc = 'bg-success';
                    else if (rv.includes('pending') || rv.includes('‡∏£‡∏≠')) rc = 'bg-warning text-dark';
                    
                    let displayRes = row.result;
                    if(displayRes.length > 25) {
                        displayRes = displayRes.substring(0, 25) + '... <i class="fas fa-search-plus ms-1"></i>';
                        resBadge = `<span class="badge ${rc} text-wrap text-start" style="max-width: 140px; line-height: 1.4; cursor:pointer;" onclick="showFullText('ANNUAL', '${row.id}', 'result')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">${displayRes}</span>`;
                    } else {
                        resBadge = `<span class="badge ${rc} text-wrap text-start" style="max-width: 140px; line-height: 1.4;">${displayRes}</span>`;
                    }
                }
                
                let exportIcon = row.exportStatus ? `<i class="fas fa-file-export text-success fs-5"></i>` : `<span class="text-muted">-</span>`;

                // üåü ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (Annual)
                let deleteBtn = isUserAdmin ? `<button class="btn btn-sm btn-soft-danger ms-1" onclick="deleteAnnualItem('${row.id}')" title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="fas fa-trash-alt"></i></button>` : '';

                let safeNoteAnnual = (row.note || '').replace(/"/g, '&quot;');

                tr.innerHTML = `
                    <td class="text-center align-top pt-3">${index+1}</td>
                    <td class="fw-bold align-top pt-3">${refCodeDisplay}</td>
                    <td class="align-top pt-3">${row.name||'-'} ${importBadge}</td>
                    <td class="text-center align-top pt-3"><span class="badge ${groupBadgeClass}">${grp||'-'}</span></td>
                    <td class="font-monospace align-top pt-3">${formatIdCard(row.idCard)}</td>
                    <td class="align-top pt-2">${paymentHtml}</td>
                    <td class="align-top pt-3"><span class="badge bg-light text-dark border">${row.channel||'-'}</span></td>
                    <td class="align-top pt-3">${row.statusProcess||'-'}</td>
                    <td class="align-top pt-3">${row.resultDate||'-'}</td>
                    <td class="text-center fw-bold bg-warning bg-opacity-10 align-top pt-3">${resBadge}</td>
                    <td class="align-top pt-2">
                        <!-- üåü ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô -->
                        <div class="input-group input-group-sm" style="min-width: 220px;">
                            <input type="text" class="form-control shadow-none bg-light note-input" value="${safeNoteAnnual}" id="note-${row.id}" onchange="saveInlineNote('${row.id}', this.value)" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
                            <button class="btn btn-light border text-muted hover-bg-primary" type="button" onclick="editFullNotePopup('${row.id}')" title="‡∏≠‡πà‡∏≤‡∏ô/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                        </div>
                    </td>
                    <td class="text-center align-top pt-3">${exportIcon}</td>
                    <td class="text-center align-top pt-3"><div class="d-flex justify-content-center align-items-center"><button class="btn btn-sm btn-soft-warning text-dark" onclick="openEditModal('${row.id}')"><i class="fas fa-edit"></i></button>${deleteBtn}</div></td>
                `;
                tbody.appendChild(tr);
            });
            if (recentlyUpdatedAnnual.length > 0) setTimeout(() => { document.querySelectorAll('.row-updated').forEach(el => el.classList.remove('row-updated')); recentlyUpdatedAnnual = []; }, 3000);
        }
    }

    // =====================================
    // üåü Modals & Edits üåü
    // =====================================
    function openAddModal() {
        if(currentTab === 'MASTER') {
            document.getElementById('dataFormMaster').reset();
            document.getElementById('m_recordId').value = "";
            document.getElementById('m_officer').value = currentUser;
            document.getElementById('m_submitDate')._flatpickr.setDate(new Date());
            formModalMaster.show();
        } else {
            document.getElementById('dataFormAnnual').reset();
            document.getElementById('a_recordId').value = "";
            document.getElementById('a_officerEmail').value = currentUser;
            formModalAnnual.show();
        }
    }

    function openEditModal(id) {
        if (currentTab === 'MASTER') {
            const item = globalDataMaster.find(x => String(x.id) === String(id)); if(!item) return;
            document.getElementById('m_recordId').value = item.id;
            document.getElementById('m_code').value = item.code;
            document.getElementById('m_name').value = item.name;
            document.getElementById('m_idCard').value = formatIdCard(item.idCard);
            document.getElementById('m_phone').value = item.phone;
            setFlatpickrValue('m_trainingDate', item.trainingDate);
            setFlatpickrValue('m_submitDate', item.submitDate);
            setFlatpickrValue('m_resultDate', item.resultDate);
            document.getElementById('m_center').value = item.center || "";
            document.getElementById('m_officer').value = item.officer;
            
            // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dropdown ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const mResultEl = document.getElementById('m_result');
            let itemResult = item.result || "";
            let optionExists = Array.from(mResultEl.options).some(opt => opt.value === itemResult);
            if (!optionExists && itemResult) {
                mResultEl.add(new Option(itemResult, itemResult));
            }
            mResultEl.value = itemResult;
            
            document.getElementById('m_ftStatus').value = item.ftStatus;
            document.getElementById('m_note').value = item.note;
            formModalMaster.show();
        } else {
            const item = globalDataAnnual.find(x => String(x.id) === String(id)); if(!item) return;
            document.getElementById('a_recordId').value = item.id;
            document.getElementById('a_refCode').value = item.refCode;
            document.getElementById('a_name').value = item.name;
            document.getElementById('a_group').value = item.group;
            document.getElementById('a_idCard').value = formatIdCard(item.idCard);
            setFlatpickrValue('a_birthDate', item.birthDate);
            document.getElementById('a_phone').value = item.phone;
            document.getElementById('a_consentStatus').value = item.consentStatus;
            document.getElementById('a_amount').value = item.amount;
            document.getElementById('a_outstanding').value = item.outstanding;
            document.getElementById('a_deductionStatus').value = item.deductionStatus;
            document.getElementById('a_channel').value = item.channel;
            document.getElementById('a_statusProcess').value = item.statusProcess;
            setFlatpickrValue('a_resultDate', item.resultDate);
            document.getElementById('a_result').value = item.result || "";
            document.getElementById('a_note').value = item.note;
            formModalAnnual.show();
        }
    }

    function setFlatpickrValue(id, val) {
        const el = document.getElementById(id);
        if(el && el._flatpickr) {
            if(!val) el._flatpickr.clear();
            else {
                let v = val;
                if(v.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                    let p = v.split('/');
                    v = `${parseInt(p[2])>2400?p[2]-543:p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                } else if(v.match(/^\d{4}-\d{2}-\d{2}/)) {
                    v = v.substring(0, 10);
                }
                el._flatpickr.setDate(v);
            }
        }
    }

    // üåü Auto Update Logic üåü
    function autoUpdateMasterStatus() {
        const resultEl = document.getElementById('m_result');
        const r = resultEl.value.trim();
        const rLower = r.toLowerCase();
        
        if(!r) return;
        
        // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ === ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" ‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö "‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"
        if(r === '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥' || rLower.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rLower.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) {
            resultEl.value = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; 
            document.getElementById('m_ftStatus').value = 'Verified'; 
            setFlatpickrValue('m_resultDate', new Date().toISOString().split('T')[0]);
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ / Verified', showConfirmButton:false, timer:2000});
        } else if (r === '‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥' || rLower.includes('kyc ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') || rLower.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) {
            resultEl.value = '‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; 
            document.getElementById('m_ftStatus').value = 'Not Verified'; 
            setFlatpickrValue('m_resultDate', new Date().toISOString().split('T')[0]);
            Swal.fire({toast:true, position:'top-end', icon:'info', title:'‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô: ‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ / Not Verified', showConfirmButton:false, timer:2000});
        }
    }
    
    function autoUpdateAnnualStatus() {
        const r = document.getElementById('a_result').value.trim();
        const rLower = r.toLowerCase();
        if(rLower.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß') || rLower.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) {
            document.getElementById('a_statusProcess').value = '‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; 
            setFlatpickrValue('a_resultDate', new Date().toISOString().split('T')[0]);
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton:false, timer:2000});
        }
    }

    function saveMasterData() {
        const form = {
            id: document.getElementById('m_recordId').value, code: document.getElementById('m_code').value, name: document.getElementById('m_name').value, idCard: document.getElementById('m_idCard').value.replace(/-/g,''), phone: document.getElementById('m_phone').value, trainingDate: document.getElementById('m_trainingDate').value, submitDate: document.getElementById('m_submitDate').value, center: document.getElementById('m_center').value, officer: document.getElementById('m_officer').value, resultDate: document.getElementById('m_resultDate').value, result: document.getElementById('m_result').value, ftStatus: document.getElementById('m_ftStatus').value, note: document.getElementById('m_note').value
        };
        showLoading(); google.script.run.withSuccessHandler(res => { hideLoading(); if(res.success){ formModalMaster.hide(); loadData(); Swal.fire({toast:true, position:'top-end', icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:2000, showConfirmButton:false}); } else showError(res.message); }).saveData(form);
    }

    function saveAnnualData() {
        const form = {
            id: document.getElementById('a_recordId').value, refCode: document.getElementById('a_refCode').value, name: document.getElementById('a_name').value, group: document.getElementById('a_group').value, idCard: document.getElementById('a_idCard').value.replace(/-/g,''), birthDate: document.getElementById('a_birthDate').value, phone: document.getElementById('a_phone').value, consentStatus: document.getElementById('a_consentStatus').value, amount: document.getElementById('a_amount').value, outstanding: document.getElementById('a_outstanding').value, deductionStatus: document.getElementById('a_deductionStatus').value, channel: document.getElementById('a_channel').value, statusProcess: document.getElementById('a_statusProcess').value, resultDate: document.getElementById('a_resultDate').value, result: document.getElementById('a_result').value, note: document.getElementById('a_note').value, officerEmail: currentUser
        };
        showLoading(); google.script.run.withSuccessHandler(res => { hideLoading(); if(res.success){ formModalAnnual.hide(); loadData(); Swal.fire({toast:true, position:'top-end', icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:2000, showConfirmButton:false}); } else showError(res.message); }).saveAnnualData(form);
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà üåü
    function deleteMasterItem(id) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
            text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                google.script.run.withSuccessHandler(() => {
                    hideLoading();
                    Swal.fire({toast:true, position:'top-end', icon:'success', title:'‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton:false, timer:2000});
                    loadData();
                }).deleteData(id); // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            }
        });
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ üåü
    function deleteAnnualItem(id) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
            text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                google.script.run.withSuccessHandler(() => {
                    hideLoading();
                    Swal.fire({toast:true, position:'top-end', icon:'success', title:'‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton:false, timer:2000});
                    loadData();
                }).deleteAnnualData(id); // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            }
        });
    }

    function saveInlineNote(id, newNote) {
        let finalNote = newNote.trim(); 
        if (finalNote) { 
            const now = new Date(); 
            const timeStr = `(${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()+543} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')})`; 
            if (!finalNote.includes('(')) finalNote = `${timeStr} ${finalNote}`; 
        }
        
        const inputEl = document.getElementById(`note-${id}`);
        if(inputEl) {
            inputEl.classList.add('bg-warning', 'bg-opacity-10'); 
        }

        google.script.run.withSuccessHandler(() => { 
            if(inputEl) {
                inputEl.classList.remove('bg-warning', 'bg-opacity-10');
                inputEl.classList.add('is-valid'); 
                setTimeout(() => inputEl.classList.remove('is-valid'), 2000);
                inputEl.value = finalNote; 
            }
            const row = globalDataAnnual.find(r => String(r.id) === String(id)); 
            if(row) row.note = finalNote; 
            
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton:false, timer:1500});
        }).updateAnnualNote(id, finalNote);
    }

    // =====================================
    // üåü UNIFIED BULK UPLOAD (APP MAN) üåü
    // =====================================
    function handleUnifiedBulkUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.name.match(/\.(csv|xlsx|xls)$/i)) { Swal.fire('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡∏´‡∏£‡∏∑‡∏≠ Excel', 'error'); event.target.value=''; return; }

        const reader = new FileReader();
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                
                if (jsonData.length <= 1) { Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '', 'warning'); event.target.value = ''; return; }

                const headers = jsonData[0].map(h => String(h||'').toLowerCase().trim());
                let idCol = 1, statusCol = 2; 
                headers.forEach((h, idx) => {
                    if (h.includes('id card') || h.includes('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£')) idCol = idx;
                    if (h.includes('status') || h.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞') || h.includes('‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à')) statusCol = idx;
                });

                let records = [];
                for(let i=1; i<jsonData.length; i++) {
                    records.push({
                        idCard: jsonData[i][idCol] ? String(jsonData[i][idCol]).trim() : "",
                        status: jsonData[i][statusCol] ? String(jsonData[i][statusCol]).trim() : "" 
                    });
                }
                Swal.close();
                
                Swal.fire({
                    title: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`,
                    html: `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô <b>‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Annual)</b> ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å<br><small class="text-muted">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà (Master)</small>`,
                    icon: 'info', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', confirmButtonColor: '#198754'
                }).then((res) => {
                    if(res.isConfirmed) {
                        showLoading();
                        google.script.run.withSuccessHandler(r => {
                            hideLoading();
                            if(r.success) {
                                recentlyUpdatedMaster = r.updatedMasterIds || [];
                                recentlyUpdatedAnnual = r.updatedAnnualIds || [];
                                
                                document.getElementById('resMasterCount').textContent = r.masterCount;
                                document.getElementById('resAnnualCount').textContent = r.annualCount;
                                document.getElementById('resFailedCount').textContent = r.failedCount;
                                
                                const tbody = document.getElementById('uploadResultTableBody'); tbody.innerHTML = '';
                                
                                r.successItems.forEach(item => {
                                    let badge = 'bg-secondary';
                                    let s = item.status.toLowerCase();
                                    if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) badge = 'bg-danger';
                                    else if(s.includes('‡∏ú‡πà‡∏≤‡∏ô')||s.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•')||s.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) badge = 'bg-success';
                                    
                                    let targets = [];
                                    if(item.masterMatch) targets.push('<span class="badge bg-primary">Master</span>');
                                    if(item.annualMatch) targets.push('<span class="badge bg-warning text-dark">Annual</span>');
                                    
                                    tbody.innerHTML += `<tr><td class="font-monospace ps-4">${item.idCard}</td><td><span class="badge ${badge}">${item.status}</span></td><td>${targets.join(' ')}</td></tr>`;
                                });
                                
                                r.failedItems.forEach(item => {
                                    tbody.innerHTML += `<tr class="table-danger"><td class="font-monospace ps-4">${item.idCard}</td><td><span class="badge bg-danger">${item.status}</span></td><td class="text-danger fw-bold"><i class="fas fa-times me-1"></i>${item.reason}</td></tr>`;
                                });
                                
                                uploadResultModal.show();
                                loadData();
                            } else showError(r.message);
                        }).withFailureHandler(err => { hideLoading(); showError(err.message); }).processUnifiedBulkUpdate(records, file.name, currentUser);
                    }
                });
            } catch (error) { Swal.fire('Error', error.message, 'error'); }
            event.target.value = ''; 
        };
        reader.readAsArrayBuffer(file);
    }

    // =====================================
    // üåü IMPORT ANNUAL DATA (BIG FILE) üåü
    // =====================================
    function handleFileSelect(input) {
      if (!input.files || input.files.length === 0) return;
      const file = input.files[0];
      const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
      const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear();
      let monthOpts = ""; thaiMonths.forEach((m, i) => { monthOpts += `<option value="${i+1}" ${i===currentMonth?'selected':''}>${m}</option>`; });
      let yearOpts = ""; for(let y=currentYear-1; y<=currentYear+1; y++) { yearOpts += `<option value="${y}" ${y===currentYear?'selected':''}>${y+543}</option>`; }
      Swal.fire({
          title: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ', html: `<div class="d-flex gap-2 justify-content-center"><select id="swal-month" class="form-select">${monthOpts}</select><select id="swal-year" class="form-select">${yearOpts}</select></div>`,
          showCancelButton: true, confirmButtonText: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          preConfirm: () => { const m = document.getElementById('swal-month').value.padStart(2, '0'); const y = document.getElementById('swal-year').value; return `${y}-${m}-01`; }
      }).then((result) => { if (result.isConfirmed) { if(monthPickerInstance) monthPickerInstance.setDate(result.value); processFile(file, result.value); } else { input.value = ""; } });
    }

    function excelDateToJSDate(serial) { 
        if (!serial) return ""; 
        if (typeof serial === 'string' && serial.includes('-')) return serial; 
        if (isNaN(serial)) return serial; 
        let date = new Date((serial - (25567 + 2)) * 86400 * 1000); 
        return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`; 
    }
    
    function processFile(file, selectedDate) {
      const reader = new FileReader(); Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
        if (jsonData.length < 1) { showError('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
        const records = [];
        for(let i=1; i<jsonData.length; i++) {
            const row = jsonData[i]; if(!row[0] && !row[3]) continue;
            let outstandingVal = row[8]; let derivedDeductionStatus = "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞";
            if (outstandingVal===undefined || outstandingVal===null || outstandingVal==="" || String(outstandingVal).trim()==="-" || Number(outstandingVal)===0) derivedDeductionStatus = "‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö";
            records.push({ refCode: row[0]||"", name: row[1]||"", group: row[2]||"A", idCard: String(row[3]||""), birthDate: excelDateToJSDate(row[4]), phone: row[5]||"", consentStatus: row[6]||"", amount: row[7]||"", outstanding: row[8]||"", deductionStatus: derivedDeductionStatus, channel: row[10]||"App Man", statusProcess: row[11]||"‡∏™‡πà‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", resultDate: excelDateToJSDate(row[12]), result: row[13]||"", note: row[14] || "", officerEmail: currentUser, submitDate: selectedDate });
        }
        
        google.script.run.withSuccessHandler(res => { 
            if(res.success) { 
                lastImportAdded = res.addedIds || []; 
                lastImportUpdated = res.updatedIds || []; 
                
                let addedCount = res.added !== undefined ? res.added : lastImportAdded.length;
                let updatedCount = res.updated !== undefined ? res.updated : lastImportUpdated.length;

                const lblNew = document.getElementById('lblImportNew');
                if (lblNew) lblNew.innerHTML = `‡πÉ‡∏´‡∏°‡πà <span class="badge bg-primary ms-1">${addedCount}</span>`;
                const lblUpdated = document.getElementById('lblImportUpdated');
                if (lblUpdated) lblUpdated.innerHTML = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï <span class="badge bg-warning text-dark ms-1">${updatedCount}</span>`;

                let htmlContent = `
                    <div class="text-start mt-3">
                        <div class="alert alert-info py-2 mb-2"><i class="fas fa-file-excel me-2"></i>‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: <b>${records.length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        <div class="alert alert-primary py-2 mb-2"><i class="fas fa-plus-circle me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà: <b>${addedCount}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        <div class="alert alert-warning text-dark py-2 mb-0"><i class="fas fa-edit me-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°: <b>${updatedCount}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                `;

                Swal.fire({
                    title: '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ',
                    html: htmlContent,
                    icon: 'success',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#0d6efd'
                });
                
                loadData(); 
            } else { 
                showError(res.message); 
            } 
            document.getElementById('importFile').value = ""; 
        }).importAnnualData(records, selectedDate);
      }; reader.readAsArrayBuffer(file);
    }

    // =====================================
    // üåü EXPORT PREVIEW LOGIC üåü
    // =====================================
    function openExportModal() {
        const monthVal = document.getElementById('monthFilter').value;
        let displayText = monthVal ? `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthVal}` : "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
        document.getElementById('exportMonthDisplay').textContent = displayText;

        const optionsContainer = document.getElementById('exportOptionsContainer');
        optionsContainer.innerHTML = '';

        if (currentTab === 'MASTER') {
            optionsContainer.innerHTML = `
                <button class="btn btn-outline-success p-2 text-start" onclick="previewExport('Verified')"><i class="fas fa-check-circle me-2"></i> Verified (‡∏ú‡πà‡∏≤‡∏ô)</button>
                <button class="btn btn-outline-warning text-dark p-2 text-start" onclick="previewExport('Pending Result')"><i class="fas fa-exclamation-triangle me-2"></i> Pending Result (‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°)</button>
                <button class="btn btn-outline-danger p-2 text-start" onclick="previewExport('Not Verified')"><i class="fas fa-times-circle me-2"></i> Not Verified (‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)</button>
                <button class="btn btn-outline-info text-dark p-2 text-start" onclick="previewExport('In Progress')"><i class="fas fa-spinner me-2"></i> In Progress (‡∏£‡∏≠‡∏ú‡∏•)</button>
            `;
        } else {
            optionsContainer.innerHTML = `
                <button class="btn btn-success p-3 text-start shadow-sm border-0" onclick="previewExport('ALL')">
                    <div class="d-flex justify-content-between align-items-center"><span><i class="fas fa-check-circle me-2"></i> Export ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span><i class="fas fa-download"></i></div>
                </button>
            `;
        }
        exportModal.show();
    }

    function previewExport(exportStatus) {
       currentExportStatus = exportStatus;
       const filterVal = document.getElementById('monthFilter').value;
       showLoading();
       
       if(currentTab === 'MASTER') {
           google.script.run.withSuccessHandler(showPreviewModal).withFailureHandler(err => { hideLoading(); showError(err.message); }).exportMasterCSV(exportStatus, filterVal, true);
       } else {
           google.script.run.withSuccessHandler(showPreviewModal).withFailureHandler(err => { hideLoading(); showError(err.message); }).exportAnnualCSV(exportStatus, filterVal, true);
       }
    }

    function showPreviewModal(data) {
        hideLoading();
        if (!data || data.length === 0) { Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'info'); return; }
        
        const tbody = document.getElementById('previewTableBody'); 
        tbody.innerHTML = "";
        
        data.forEach(row => { 
            let codeCol = currentTab === 'MASTER' ? row.code : row.refCode;
            let statusCol = currentTab === 'MASTER' ? row.ftStatus : row.statusProcess;
            tbody.innerHTML += `<tr><td>${codeCol||'-'}</td><td>${row.name||'-'}</td><td>${row.idCard||'-'}</td><td><span class="badge bg-secondary">${statusCol||'-'}</span></td></tr>`; 
        });
        
        exportModal.hide(); 
        previewModal.show();
    }

    function confirmExport() {
       if (!currentExportStatus) return;
       const filterVal = document.getElementById('monthFilter').value;
       previewModal.hide(); 
       showLoading();
       
       if (currentTab === 'MASTER') {
           google.script.run.withSuccessHandler(result => {
               hideLoading();
               if (result.count > 0) { const b=new Blob(["\ufeff"+result.content],{type:'text/csv'}); const l=document.createElement('a'); l.href=URL.createObjectURL(b); l.download=result.filename; l.click(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `Export ${result.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success'); loadData(); } 
               else Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
           }).withFailureHandler(err => { hideLoading(); showError(err.message); }).exportMasterCSV(currentExportStatus, filterVal, false);
       } else {
           google.script.run.withSuccessHandler(result => {
               hideLoading();
               if (result.count > 0) { const b=new Blob(["\ufeff"+result.content],{type:'text/csv'}); const l=document.createElement('a'); l.href=URL.createObjectURL(b); l.download=result.filename; l.click(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `Export ${result.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success'); loadData(); } 
               else Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
           }).withFailureHandler(err => { hideLoading(); showError(err.message); }).exportAnnualCSV(currentExportStatus, filterVal, false);
       }
    }

    // =====================================
    // üåü VIEW HISTORY LOGIC üåü
    // =====================================
    function viewHistory() {
        showLoading();
        google.script.run.withSuccessHandler(logs => {
            hideLoading();
            const tbody = document.getElementById('historyTableBody'); tbody.innerHTML = '';
            if(!logs || logs.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>'; return; }
            logs.forEach((log, idx) => {
                if(!window.uploadLogsData) window.uploadLogsData = []; window.uploadLogsData[idx] = log;
                tbody.innerHTML += `
                    <tr>
                        <td class="ps-4 fw-bold text-dark"><i class="far fa-clock me-2 text-muted"></i>${log.timestamp}</td>
                        <td class="small text-muted"><i class="fas fa-file-excel me-1 text-success"></i>${log.fileName}</td>
                        <td><span class="badge bg-light text-secondary border">${log.user}</span></td>
                        <td class="text-center"><span class="badge bg-success rounded-pill px-2 py-1">${log.successCount}</span></td>
                        <td class="text-center"><span class="badge bg-danger rounded-pill px-2 py-1">${log.failedCount}</span></td>
                        <td class="text-center pe-4">
                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô Popup -->
                            <button class="btn btn-sm btn-outline-info rounded-pill px-3 me-1" onclick="viewLogDetails(${idx})" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="downloadLogCSV(${idx})" title="‡πÇ‡∏´‡∏•‡∏î CSV"><i class="fas fa-download"></i></button>
                        </td>
                    </tr>
                `;
            });
            historyModal.show();
        }).getUploadLogs('UNIFIED_VERIFY');
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô Popup üåü
    function viewLogDetails(idx) {
        const log = window.uploadLogsData[idx]; if(!log) return;
        const tbody = document.getElementById('logDetailsTableBody');
        tbody.innerHTML = '';
        
        // ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        (log.successItems||[]).forEach(item => {
            const info = getProviderInfo(item.idCard);
            let s = item.status.toLowerCase();
            let badge = 'bg-secondary';
            if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) badge = 'bg-danger';
            else if(s.includes('‡∏ú‡πà‡∏≤‡∏ô')||s.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•')||s.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) badge = 'bg-success';
            
            let targets = [];
            if(item.masterMatch) targets.push('<span class="badge bg-primary">Master</span>');
            if(item.annualMatch) targets.push('<span class="badge bg-warning text-dark">Annual</span>');

            let codeDisplay = info.code !== '-' ? `<span class="badge bg-light text-dark border">${info.code}</span>` : '<span class="text-muted">-</span>';

            tbody.innerHTML += `
                <tr>
                    <td class="ps-4">${codeDisplay}</td>
                    <td class="fw-bold">${info.name}</td>
                    <td class="font-monospace">${item.idCard}</td>
                    <td><span class="badge ${badge}">${item.status}</span></td>
                    <td>${targets.join(' ')}</td>
                </tr>
            `;
        });
        
        // ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        (log.failedItems||[]).forEach(item => {
            const info = getProviderInfo(item.idCard);
            let codeDisplay = info.code !== '-' ? `<span class="badge bg-light text-dark border">${info.code}</span>` : '<span class="text-muted">-</span>';
            tbody.innerHTML += `
                <tr class="table-danger">
                    <td class="ps-4">${codeDisplay}</td>
                    <td class="fw-bold">${info.name}</td>
                    <td class="font-monospace">${item.idCard}</td>
                    <td><span class="badge bg-danger">${item.status}</span></td>
                    <td class="text-danger fw-bold"><i class="fas fa-times me-1"></i>${item.reason}</td>
                </tr>
            `;
        });
        
        logDetailsModal.show();
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á üåü
    function downloadLogCSV(idx) {
        const log = window.uploadLogsData[idx]; if(!log) return;
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÇ‡∏î‡∏¢‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Update Result ‡∏≠‡∏≠‡∏Å
        let csv = "Code,Name,ID Card,Status,Reason\n";
        
        (log.successItems||[]).forEach(i => {
            const info = getProviderInfo(i.idCard);
            let targets = [];
            if(i.masterMatch) targets.push("Master");
            if(i.annualMatch) targets.push("Annual");
            let reason = "Updated: " + targets.join(' & ');
            
            csv += `="${info.code||''}","${info.name||''}","="${i.idCard||''}","${i.status||''}","${reason}"\n`;
        });
        
        (log.failedItems||[]).forEach(i => {
            const info = getProviderInfo(i.idCard);
            csv += `="${info.code||''}","${info.name||''}","="${i.idCard||''}","${i.status||''}","${i.reason||''}"\n`;
        });
        
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Unified_Verify_Log_${log.timestamp.replace(/[:\/ ]/g, '_')}.csv`; link.click();
    }
    
  </script>
</body>
</html>
